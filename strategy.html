<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Strategy Hub - Advanced Edition</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --row-height: 60px; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #121212; color: #eee; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar { width: 300px; background: #1a1a1a; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; gap: 12px; z-index: 2000; box-sizing: border-box; overflow-y: auto; }
        .sidebar h2 { margin: 0; font-size: 18px; color: #fff; border-left: 4px solid #4caf50; padding-left: 10px; }
        label { font-size: 11px; color: #888; display: block; margin-bottom: 4px; }
        input, select, textarea { background: #262626; border: 1px solid #3d3d3d; color: white; padding: 8px; border-radius: 4px; font-size: 13px; width: 100%; box-sizing: border-box; }
        
        .section-title { font-size: 12px; font-weight: bold; color: #4caf50; margin-top: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .filter-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .filter-item { display: flex; align-items: center; gap: 5px; font-size: 11px; cursor: pointer; }
        .filter-item input { width: auto; cursor: pointer; }

        /* ãƒ¡ã‚¤ãƒ³ãƒœãƒ¼ãƒ‰ */
        .main-board { flex-grow: 1; overflow-y: auto; background: #0d0d0d; position: relative; }
        #timelineWrapper { position: relative; width: 100%; min-height: 100%; }
        .time-row { position: absolute; left: 0; right: 0; height: var(--row-height); border-bottom: 1px solid #1a1a1a; pointer-events: none; color: #444; font-size: 11px; padding-left: 5px; }
        #play-line { position: absolute; left: 0; right: 0; height: 2px; background: #ff0000; z-index: 500; pointer-events: none; box-shadow: 0 0 10px rgba(255,0,0,0.8); }

        /* ä»˜ç®‹ */
        .sticky-note { 
            position: absolute; background: #2a2a2a; border-radius: 4px; padding: 6px; border-left: 5px solid #666; 
            font-size: 12px; box-sizing: border-box; z-index: 100; color: white; cursor: grab; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); user-select: none;
        }
        .sticky-note.active { filter: brightness(1.3); box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); z-index: 151; border-left-width: 8px; }
        .note-enemy { border-left-color: #ff5722; }
        .note-mt, .note-st { border-left-color: #2196f3; }
        .note-ph, .note-bh { border-left-color: #4caf50; }
        .note-dps { border-left-color: #e91e63; }
        .note-misc { border-left-color: #9e9e9e; }

        /* ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨ªä¸¦ã³ç¶­æŒãƒ»ç¸¦è©°ã‚ï¼‰ */
        .list-mode .time-row, .list-mode #play-line { display: none; }
        .list-mode #timelineWrapper { padding: 20px 0; height: auto !important; }
        /* ãƒ•ã‚£ãƒ«ã‚¿éè¡¨ç¤º */
        .hidden { display: none !important; }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        #floatPopup { position: absolute; background: #252525; border: 1px solid #444; padding: 15px; border-radius: 8px; z-index: 3000; display: none; width: 250px; flex-direction: column; gap: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .resizer { width: 10px; height: 10px; position: absolute; right: 0; bottom: 0; cursor: nwse-resize; }
        .btn-delete { position: absolute; top: 2px; right: 2px; background: none; border: none; color: white; opacity: 0.3; cursor: pointer; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Strategy Hub</h2>
    
    <div>
        <label>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é¸æŠ</label>
        <select id="contentSelect" onchange="loadTimelineMemos()"></select>
    </div>

    <div class="section-title">æ–°è¦ä½œæˆæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</div>
    <div>
        <select id="sidebarRole">
            <option value="enemy">ğŸ˜ˆ æ•µã®è¡Œå‹•</option>
            <option value="mt">ğŸ›¡ï¸ MT</option>
            <option value="st">ğŸ›¡ï¸ ST</option>
            <option value="ph">âš–ï¸ PH</option>
            <option value="bh">âš–ï¸ BH</option>
            <option value="dps">âš”ï¸ DPS</option>
            <option value="misc">ğŸ“ é›‘ãƒ¡ãƒ¢</option>
        </select>
        <p style="font-size:10px; color:#666; margin:4px 0 0 0;">â€»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ä½œæˆæ™‚ã«é©ç”¨ã•ã‚Œã¾ã™</p>
    </div>

    <div class="section-title">å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</div>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
        <button onclick="startPlayback()" style="background:#1565c0; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">START</button>
        <button onclick="stopPlayback()" style="background:#c62828; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">STOP</button>
        <button onclick="resetPlayback()" style="background:#444; color:white; border:none; padding:8px; border-radius:4px; cursor:pointer;">RESET</button>
    </div>

    <div class="section-title">è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿</div>
    <div class="filter-group" id="filterGroup">
        <label class="filter-item"><input type="checkbox" checked value="enemy" onchange="applyFilter()"> æ•µè¡Œå‹•</label>
        <label class="filter-item"><input type="checkbox" checked value="mt" onchange="applyFilter()"> MT</label>
        <label class="filter-item"><input type="checkbox" checked value="st" onchange="applyFilter()"> ST</label>
        <label class="filter-item"><input type="checkbox" checked value="ph" onchange="applyFilter()"> PH</label>
        <label class="filter-item"><input type="checkbox" checked value="bh" onchange="applyFilter()"> BH</label>
        <label class="filter-item"><input type="checkbox" checked value="dps" onchange="applyFilter()"> DPS</label>
        <label class="filter-item"><input type="checkbox" checked value="misc" onchange="applyFilter()"> é›‘ãƒ¡ãƒ¢</label>
    </div>

    <div class="section-title">è¡¨ç¤ºè¨­å®š</div>
    <div style="display:flex; gap:5px;">
        <button id="btnT" onclick="setViewMode('timeline')" style="flex:1; background:#4caf50; color:white; border:none; padding:6px; border-radius:4px;">TIME</button>
        <button id="btnL" onclick="setViewMode('list')" style="flex:1; background:#333; color:white; border:none; padding:6px; border-radius:4px;">LIST</button>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:11px;">ã‚ºãƒ¼ãƒ :</span>
        <div>
            <button onclick="changeZoom(-10)" style="padding:2px 8px;">â–</button>
            <button onclick="changeZoom(10)" style="padding:2px 8px;">â•</button>
        </div>
    </div>

    <div class="section-title">ãƒ‡ãƒ¼ã‚¿</div>
    <button onclick="exportJSON()" style="background:#333; color:white; border:1px solid #555; padding:8px; border-radius:4px; cursor:pointer; font-size:11px;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜</button>
    <div style="font-size:10px; color:#666; margin-top:5px;">â€» JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™</div>
</div>


<div class="main-board" id="mainBoard" ondblclick="handleBoardDblClick(event)">
    <div id="play-line"></div>
    <div id="timelineList"></div>
    
    <div id="floatPopup">
        <h4 id="popupTitle" style="margin:0; font-size:13px; color:#4caf50;">ç·¨é›†</h4>
        <select id="popRoleInput">
            <option value="enemy">ğŸ˜ˆ æ•µã®è¡Œå‹•</option>
            <option value="mt">ğŸ›¡ï¸ MT</option><option value="st">ğŸ›¡ï¸ ST</option>
            <option value="ph">âš–ï¸ PH</option><option value="bh">âš–ï¸ BH</option>
            <option value="dps">âš”ï¸ DPS</option><option value="misc">ğŸ“ é›‘ãƒ¡ãƒ¢</option>
        </select>
        <input type="text" id="popTitleInput" placeholder="æŠ€å">
        <textarea id="popDetailInput" rows="3" placeholder="è©³ç´°"></textarea>
        <div style="display:flex; gap:5px;">
            <button onclick="savePopup()" style="flex:1; background:#4caf50; color:white; border:none; padding:8px; border-radius:4px;">ä¿å­˜</button>
            <button onclick="closePopup()" style="flex:1; background:#444; color:white; border:none; padding:8px; border-radius:4px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentTime = 0, isPlaying = false, startTime = 0, elapsedTimeAtPause = 0;
    let rowHeight = 60, viewMode = 'timeline';
    let currentEditingKey = null, tempTargetSec = 0;

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60);
        return `${m}:${sec.toString().padStart(2, '0')}`;
    }

    function setViewMode(mode) {
        viewMode = mode;
        document.getElementById('mainBoard').className = 'main-board ' + (mode === 'list' ? 'list-mode' : '');
        document.getElementById('btnT').style.background = (mode === 'timeline' ? '#4caf50' : '#333');
        document.getElementById('btnL').style.background = (mode === 'list' ? '#4caf50' : '#333');
        loadTimelineMemos();
    }

    // è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ã®å®Ÿè¡Œé–¢æ•°
    function applyFilter() {
        const checks = document.querySelectorAll('#filterGroup input');
        const activeRoles = Array.from(checks).filter(c => c.checked).map(c => c.value);
        
        document.querySelectorAll('.sticky-note').forEach(note => {
            // ãƒ­ãƒ¼ãƒ«ãŒæœªè¨­å®šï¼ˆundefinedã‚„ç©ºï¼‰ã®å ´åˆã¯ "enemy" ã¨ã—ã¦æ‰±ã†æ•‘æ¸ˆå‡¦ç½®
            const role = note.getAttribute('data-role') || "enemy";
            if (activeRoles.includes(role)) {
                note.classList.remove('hidden');
            } else {
                note.classList.add('hidden');
            }
        });
    }

    function exportJSON() {
        const id = document.getElementById('contentSelect').value;
        db.ref(`savedMemos/${id}`).once('value', snap => {
            const data = snap.val();
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `StrategyHub_Backup_${id}.json`;
            a.click();
        });
    }

    function changeZoom(delta) {
        rowHeight = Math.min(200, Math.max(30, rowHeight + delta));
        document.documentElement.style.setProperty('--row-height', rowHeight + 'px');
        loadTimelineMemos();
    }

    function handleBoardDblClick(e) {
        if (viewMode === 'list' || e.target.id !== 'timelineWrapper') return;
        const rect = e.target.getBoundingClientRect();
        const y = e.clientY - rect.top;
        tempTargetSec = y / rowHeight;
        showPopup(null, e.pageX - 310, e.pageY - 20, "æ–°è¦ä½œæˆ (" + formatTime(tempTargetSec) + ")");
    }

    function showPopup(key, x, y, titleText) {
        currentEditingKey = key;
        const pop = document.getElementById('floatPopup');
        document.getElementById('popupTitle').innerText = titleText;
        if (key) {
            db.ref(`savedMemos/${document.getElementById('contentSelect').value}/${key}`).once('value', snap => {
                const data = snap.val();
                document.getElementById('popTitleInput').value = data.title || "";
                document.getElementById('popDetailInput').value = data.detail || "";
                document.getElementById('popRoleInput').value = data.role || "enemy";
            });
        } else {
            document.getElementById('popTitleInput').value = ""; document.getElementById('popDetailInput').value = "";
            document.getElementById('popRoleInput').value = document.getElementById('sidebarRole').value;
        }
        pop.style.display = 'flex';
        pop.style.left = Math.max(10, x) + 'px';
        pop.style.top = (y + document.getElementById('mainBoard').scrollTop) - 50 + 'px';
    }

    function savePopup() {
        const id = document.getElementById('contentSelect').value;
        const updateData = {
            title: document.getElementById('popTitleInput').value || "(ç„¡é¡Œ)",
            detail: document.getElementById('popDetailInput').value,
            role: document.getElementById('popRoleInput').value || "enemy"
        };
        if (currentEditingKey) {
            db.ref(`savedMemos/${id}/${currentEditingKey}`).update(updateData);
        } else {
            db.ref(`savedMemos/${id}`).push({
                ...updateData, timeSec: tempTargetSec, timeStr: formatTime(tempTargetSec),
                duration: 1, width: 240, leftPos: 100
            });
        }
        closePopup();
    }

    function closePopup() { document.getElementById('floatPopup').style.display = 'none'; }

    function updateFrame() {
        if (!isPlaying) return;
        currentTime = (performance.now() - startTime) / 1000;
        const line = document.getElementById('play-line');
        const board = document.getElementById('mainBoard');
        const yPos = currentTime * rowHeight;
        if (viewMode === 'timeline') {
            line.style.top = yPos + "px";
            if (yPos > board.scrollTop + 500 || yPos < board.scrollTop) board.scrollTop = yPos - 100;
        }
        document.querySelectorAll('.sticky-note').forEach(note => {
            const start = parseFloat(note.getAttribute('data-start'));
            const dur = parseFloat(note.getAttribute('data-duration'));
            note.classList.toggle('active', currentTime >= start && currentTime < (start + dur));
        });
        requestAnimationFrame(updateFrame);
    }

    function startPlayback() { if(!isPlaying){ isPlaying=true; startTime=performance.now()-(elapsedTimeAtPause*1000); requestAnimationFrame(updateFrame); } }
    function stopPlayback() { isPlaying=false; elapsedTimeAtPause=currentTime; }
    function resetPlayback() { stopPlayback(); currentTime=0; elapsedTimeAtPause=0; if(document.getElementById('play-line')) document.getElementById('play-line').style.top="0px"; }

    function loadTimelineMemos() {
        const id = document.getElementById('contentSelect').value;
        if (!id) return;

        db.ref(`savedMemos/${id}`).on('value', snap => {
            const listEl = document.getElementById('timelineList');
            listEl.innerHTML = "";
            const data = snap.val() || {};
            const wrapper = document.createElement('div');
            wrapper.id = "timelineWrapper";
            
            // 1. ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆï¼ˆæ™‚é–“é †ï¼‰
            const sortedMemos = Object.entries(data)
                .filter(([k]) => k !== 'counters')
                .sort((a,b) => a[1].timeSec - b[1].timeSec);

            // 2. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼šèƒŒæ™¯ç›®ç››ã‚Šã®æç”»
            if (viewMode === 'timeline') {
                wrapper.style.height = (1200 * rowHeight) + "px";
                for (let i = 0; i < 600; i++) {
                    const row = document.createElement('div'); 
                    row.className = 'time-row'; 
                    row.style.top = (i * rowHeight) + "px";
                    row.innerText = formatTime(i); 
                    wrapper.appendChild(row);
                }
            }

            let lastY = 20; // ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ã®é«˜ã•ç®¡ç†
            let lastSec = -1;

            // 3. å„ä»˜ç®‹ã®ç”Ÿæˆ
            sortedMemos.forEach(([key, item]) => {
                const displayRole = item.role || "enemy"; // ãƒ­ãƒ¼ãƒ«æœªè¨­å®šæ™‚ã®æ•‘æ¸ˆ
                
                const note = document.createElement('div');
                note.className = `sticky-note note-${displayRole}`;
                note.setAttribute('data-start', item.timeSec);
                note.setAttribute('data-duration', item.duration || 1);
                note.setAttribute('data-role', displayRole);
                
                if (viewMode === 'timeline') {
                    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
                    note.style.top = (item.timeSec * rowHeight) + "px";
                    note.style.left = (item.leftPos || 80) + "px";
                    note.style.width = (item.width || 240) + "px";
                    note.style.height = ((item.duration || 1) * rowHeight - 2) + "px";
                } else {
                    // ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆæ¨ªé…ç½®ç¶­æŒãƒ»ç¸¦è©°ã‚ï¼‰
                    if (Math.abs(item.timeSec - lastSec) > 0.1) {
                        if (lastSec !== -1) lastY += 80; 
                        lastSec = item.timeSec;
                    }
                    note.style.top = lastY + "px";
                    note.style.left = (item.leftPos || 80) + "px";
                    note.style.width = (item.width || 240) + "px";
                    note.style.height = "70px";
                    wrapper.style.height = (lastY + 150) + "px";
                }

                // ä»˜ç®‹å†…éƒ¨ã®HTML
                note.innerHTML = `
                    <div style="font-size:9px; opacity:0.6;">${formatTime(item.timeSec)}</div>
                    <div style="font-weight:bold;">${item.title}</div>
                    <div style="font-size:10px; opacity:0.8; white-space:pre-wrap;">${item.detail || ''}</div>
                    <button class="btn-delete" onclick="deleteNote('${key}')">Ã—</button>
                    ${viewMode === 'timeline' ? '<div class="resizer"></div>' : ''}
                `;

                // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†
                note.ondblclick = (e) => { 
                    e.stopPropagation(); 
                    showPopup(key, e.pageX - 310, e.pageY - 20, "ç·¨é›†"); 
                };

                // 4. ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
                if (viewMode === 'timeline') {
                    note.onmousedown = (e) => {
                        if (e.target.className === 'btn-delete') return;
                        e.preventDefault();
                        const isResizing = e.target.classList.contains('resizer');
                        const startY = e.pageY, startX = e.pageX;
                        const startTop = parseFloat(note.style.top), startLeft = parseFloat(note.style.left);
                        const startH = note.offsetHeight, startW = note.offsetWidth;
                        
                        const snapUnit = rowHeight / 4; // 0.25ç§’å˜ä½

                        const move = (ev) => {
                            if (isResizing) {
                                // --- é«˜ã•ã®ã‚¹ãƒŠãƒƒãƒ— ---
                                const rawHeight = startH + (ev.pageY - startY);
                                const snappedHeight = Math.max(snapUnit, Math.round(rawHeight / snapUnit) * snapUnit);
                                note.style.height = (snappedHeight - 2) + "px";
                                // æ¨ªå¹…ã¯è‡ªç”±
                                note.style.width = Math.max(50, startW + (ev.pageX - startX)) + "px";
                            } else {
                                // --- ä½ç½®ã®ã‚¹ãƒŠãƒƒãƒ— ---
                                const rawTop = startTop + (ev.pageY - startY);
                                note.style.top = Math.max(0, Math.round(rawTop / snapUnit) * snapUnit) + "px";
                                note.style.left = Math.max(80, startLeft + (ev.pageX - startX)) + "px";
                            }
                        };

                        const up = () => {
                            document.removeEventListener('mousemove', move);
                            document.removeEventListener('mouseup', up);
                            
                            const finalTop = parseFloat(note.style.top);
                            const finalHeight = parseFloat(note.style.height) + 2; 
                            
                            const finalTimeSec = finalTop / rowHeight;
                            const finalDuration = finalHeight / rowHeight;

                            db.ref(`savedMemos/${id}/${key}`).update({
                                timeSec: finalTimeSec,
                                timeStr: formatTime(finalTimeSec),
                                duration: finalDuration,
                                leftPos: parseFloat(note.style.left),
                                width: parseFloat(note.style.width)
                            });
                        };
                        document.addEventListener('mousemove', move);
                        document.addEventListener('mouseup', up);
                    };
                }
                wrapper.appendChild(note);
            });
            listEl.appendChild(wrapper);
            
            // æœ€å¾Œã«ãƒ•ã‚£ãƒ«ã‚¿çŠ¶æ…‹ã‚’é©ç”¨
            applyFilter(); 
        });
    }

    function deleteNote(key) { event.stopPropagation(); if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) db.ref(`savedMemos/${document.getElementById('contentSelect').value}/${key}`).remove(); }

    db.ref('contentsList').on('value', snap => {
        const select = document.getElementById('contentSelect');
        const current = select.value; select.innerHTML = "";
        Object.entries(snap.val() || {}).forEach(([id, name]) => {
            const opt = document.createElement('option'); opt.value = id; opt.innerText = name; select.appendChild(opt);
        });
        if(current) select.value = current; loadTimelineMemos();
    });
</script>
</body>
</html>