<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; padding: 10px; }
        /* ストップウォッチエリア */
        .timer-box { background: #333; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px; }
        #timerDisplay { font-size: 32px; font-family: monospace; color: #00ffff; }
        .timer-btns button { padding: 10px; margin: 5px; border-radius: 5px; border: none; font-weight: bold; }
        
        /* リストスタイル */
        .memo-item { 
            display: flex; background: #2a2a2a; margin-bottom: 5px; border-radius: 5px; 
            align-items: center; cursor: grab;
        }
        .handle { padding: 15px; color: #666; cursor: grab; }
        .memo-text { flex-grow: 1; padding: 10px; }
        .time-tag { background: #444; color: #ffd700; padding: 2px 5px; border-radius: 3px; font-size: 12px; margin-right: 5px; }
        
        #editOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 1000; flex-direction: column; padding: 20px; box-sizing: border-box; }
        textarea { flex-grow: 1; background: #333; color: white; padding: 15px; font-size: 18px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="timer-box">
        <div id="timerDisplay">00:00.0</div>
        <div class="timer-btns">
            <button style="background: #28a745; color: white;" onclick="startTimer()">START</button>
            <button style="background: #ffc107;" onclick="recordTime()">タイムライン記録</button>
            <button style="background: #dc3545; color: white;" onclick="stopTimer()">STOP</button>
            <button style="background: #666; color: white;" onclick="resetTimer()">RESET</button>
        </div>
    </div>

    <div id="memoList"></div>

    <div id="editOverlay">
        <h3>メモ編集 (秒数指定: [00:00] 形式を文頭に)</h3>
        <textarea id="editArea"></textarea>
        <button onclick="saveEdit()" style="background:#28a745; color:white; padding:15px; border:none; border-radius:10px;">保存</button>
        <button onclick="closeEdit()" style="background:#666; color:white; padding:10px; border:none; border-radius:10px; margin-top:10px;">キャンセル</button>
    </div>

    <script>
        // ★Firebase設定を貼ってください
        const firebaseConfig = {
            apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
            authDomain: "raine-overlay-projects.firebaseapp.com",
            databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "raine-overlay-projects",
            storageBucket: "raine-overlay-projects.firebasestorage.app",
            messagingSenderId: "116002218964",
            appId: "1:116002218964:web:616f3503eaebacb4442c41"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let startTime, timerInterval, elapsed = 0;
        let memoOrder = [];

        // ストップウォッチ処理
        function startTimer() {
            if (timerInterval) return;
            startTime = Date.now() - elapsed;
            timerInterval = setInterval(() => {
                elapsed = Date.now() - startTime;
                const timeStr = formatTime(elapsed);
                document.getElementById('timerDisplay').innerText = timeStr;
                // 自動表示連携用にFirebaseへ秒数を送る
                db.ref('counter/currentTime').set(Math.floor(elapsed / 1000));
            }, 100);
        }

        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { stopTimer(); elapsed = 0; document.getElementById('timerDisplay').innerText = "00:00.0"; db.ref('counter/currentTime').set(0); }

        function formatTime(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            const ms1 = Math.floor((ms % 1000) / 100);
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ms1}`;
        }

        // 記録ボタン：新規メモとして現在のタイムスタンプを保存
        function recordTime() {
            const timeStr = formatTime(elapsed).substring(0, 5);
            const newMemo = `[${timeStr}] 新しいギミック記録`;
            db.ref('counter/savedMemos').push(newMemo);
        }

        // リスト表示 & 並び替え
        const listDiv = document.getElementById('memoList');
        db.ref('counter').on('value', (s) => {
            const data = s.val() || {};
            const saved = data.savedMemos || {};
            const order = data.memoOrder || Object.keys(saved);
            
            listDiv.innerHTML = "";
            order.forEach(key => {
                if(!saved[key]) return;
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.setAttribute('data-id', key);
                item.innerHTML = `<div class="handle">☰</div><div class="memo-text" onclick="applyMemo('${key}')">${saved[key]}</div>`;
                listDiv.appendChild(item);
            });
        });

        // 並び替えの有効化
        Sortable.create(listDiv, {
            handle: '.handle',
            onEnd: function() {
                const newOrder = Array.from(listDiv.children).map(el => el.getAttribute('data-id'));
                db.ref('counter/memoOrder').set(newOrder);
            }
        });

        function applyMemo(key) {
            db.ref('counter/savedMemos/' + key).once('value', (s) => {
                db.ref('counter').update({ memo: s.val(), scrollPos: 0 });
            });
        }
        
        // 編集・保存・削除は前回同様 (省略)
    </script>
</body>
</html>