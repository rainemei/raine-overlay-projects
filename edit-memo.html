<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Controller Pro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: white; padding: 0; margin: 0; overflow-x: hidden; }
        
        /* „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .tabs { display: flex; background: #222; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #444; }
        .tab-btn { flex: 1; background: #222; color: #888; border: none; padding: 15px; font-weight: bold; font-size: 14px; cursor: pointer; }
        .tab-btn.active { background: #333; color: #00ffff; border-bottom: 3px solid #00ffff; }

        .tab-content { display: none; padding: 15px; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ÂÖ•Âäõ„Éë„Éº„ÉÑ */
        .input-card { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        input, select, textarea { width: 100%; margin-bottom: 10px; background: #444; border: 1px solid #555; color: white; padding: 12px; box-sizing: border-box; font-size: 16px; border-radius: 4px; }
        
        /* „Éú„Çø„É≥ */
        button { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .btn-start { background: #28a745; color: white; }
        .btn-stop { background: #ffc107; color: black; }
        .btn-reset { background: #dc3545; color: white; }
        .btn-save { background: #007bff; color: white; margin-top: 10px; font-size: 18px; }
        .btn-timestamp { background: #17a2b8; color: white; }
        .tmpl-btn { background: #555; color: white; width: auto; display: inline-block; margin: 2px; padding: 8px 12px; }

        /* „Çø„Ç§„Éû„ÉºË°®Á§∫ */
        .timer-display { text-align: center; font-family: monospace; font-size: 56px; color: #00ffff; margin: 10px 0; text-shadow: 0 0 10px rgba(0,255,255,0.5); }

        /* „É°„É¢„É™„Çπ„Éà */
        .memo-item { background: #2a2a2a; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ffd700; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .memo-info { flex-grow: 1; cursor: pointer; }
        .memo-info b { color: #00ffff; font-size: 18px; margin-right: 5px; }
        .memo-info span { font-size: 16px; }
        .memo-info small { display: block; color: #888; font-size: 11px; margin-top: 4px; }
        .btn-edit { width: auto; background: #555; margin: 0 0 0 5px; padding: 8px; }
    </style>
</head>
<body>

<div class="tabs">
    <button id="btn-remote" class="tab-btn active" onclick="showTab('remote')">REMOTE</button>
    <button id="btn-edit" class="tab-btn" onclick="showTab('edit')">EDIT</button>
    <button id="btn-manage" class="tab-btn" onclick="showTab('manage')">MANAGE</button>
</div>

<div id="tab-remote" class="tab-content active">
    <div class="timer-display" id="remoteTimer">00:00</div>
    <div style="display: flex; gap: 8px;">
        <button class="btn-start" onclick="controlTimer('start')">START</button>
        <button class="btn-stop" onclick="controlTimer('stop')">STOP</button>
        <button class="btn-reset" onclick="controlTimer('reset')">RESET</button>
    </div>
    <div style="display: flex; gap: 8px; margin-top: 8px;">
        <button style="background:#444;" onclick="adjustTime(-5)">-5s</button>
        <button style="background:#444;" onclick="adjustTime(5)">+5s</button>
    </div>
    <button class="btn-timestamp" style="margin-top: 15px;" onclick="setCurrentTimestamp()">üïí ‰ªä„ÅÆÊôÇÈñì„Çí„Çª„ÉÉ„Éà„Åó„Å¶‰ΩúÊàê</button>
</div>

<div id="tab-edit" class="tab-content">
    <div class="input-card">
        <div style="margin-bottom: 10px;">
            <button class="tmpl-btn" onclick="setTmpl('„ÄêÂÖ®‰ΩìÊîªÊíÉ„Äë')">ÂÖ®‰Ωì</button>
            <button class="tmpl-btn" onclick="setTmpl('„ÄêÂº∑ÊîªÊíÉ„Äë')">Âº∑ÊîªÊíÉ</button>
            <button class="tmpl-btn" onclick="setTmpl('„ÄêÊï£Èñã„Äë')">Êï£Èñã</button>
            <button class="tmpl-btn" onclick="setTmpl('„ÄêÈ†≠Ââ≤„Çä„Äë')">È†≠Ââ≤„Çä</button>
            <button class="tmpl-btn" onclick="setTmpl('„Äê„Çπ„ÉÜ„Éº„Ç∏„ÇÆ„Éü„ÉÉ„ÇØ„Äë')">„Çπ„ÉÜ„Éº„Ç∏</button>
        </div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="inTime" placeholder="00:00" style="width:100px;">
            <input type="text" id="inTitle" placeholder="„Çø„Ç§„Éà„É´" style="flex-grow:1;">
            <input type="number" id="inDuration" value="3" style="width:70px;" title="Ë°®Á§∫ÁßíÊï∞">
        </div>
        <textarea id="inDetail" placeholder="Ë©≥Á¥∞„É°„É¢" rows="2"></textarea>
        <button id="btn-save-main" class="btn-save" onclick="saveMemo()">„É°„É¢„ÇíËøΩÂä†</button>
        <button id="btn-cancel-edit" style="display:none; background:#666;" onclick="cancelEdit()">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
</div>

<div id="tab-manage" class="tab-content">
    <div class="input-card">
        <label style="font-size:12px; color:#aaa;">„Ç≥„É≥„ÉÜ„É≥„ÉÑÂàáÊõø</label>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <select id="contentSelect" onchange="changeContent()" style="margin:0;"></select>
            <button onclick="addContentName()" style="width:auto; background:#007bff; margin:0;">ËøΩÂä†</button>
        </div>
        <button class="btn-reset" style="margin-top:20px; font-size:12px;" onclick="clearAllMemos()">„Åì„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„Ç™„Éº„É´„ÇØ„É™„Ç¢</button>
    </div>
</div>

<div id="memoList" style="padding: 10px;"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let editingKey = null;
    let timerInterval = null;

    // --- „Çø„ÉñÂàá„ÇäÊõø„Åà ---
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('btn-' + tabId).classList.add('active');
    }

    // --- „Ç≥„É≥„ÉÜ„É≥„ÉÑÁÆ°ÁêÜ ---
    db.ref('contentsList').on('value', (snap) => {
        const list = snap.val() || { "default": "„Éá„Éï„Ç©„É´„Éà" };
        const select = document.getElementById('contentSelect');
        const lastVal = select.value;
        select.innerHTML = "";
        Object.entries(list).forEach(([id, name]) => {
            const opt = document.createElement('option'); opt.value = id; opt.innerText = name;
            select.appendChild(opt);
        });
        if(lastVal) select.value = lastVal;
        changeContent();
    });

    function addContentName() {
        const name = prompt("Êñ∞„Åó„ÅÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑÂêç");
        if(name) db.ref(`contentsList/ID_${Date.now()}`).set(name);
    }

    function changeContent() {
        const id = document.getElementById('contentSelect').value;
        db.ref('activeContentID').set(id);
        loadMemos(id);
    }

    // --- „Çø„Ç§„Éû„ÉºÊìç‰Ωú ---
    db.ref('counter/currentTime').on('value', (snap) => {
        const t = snap.val() || 0;
        const m = Math.floor(t/60); const s = t%60;
        document.getElementById('remoteTimer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    });

    function controlTimer(action) {
        if(action === 'start'){
            if(timerInterval) return;
            timerInterval = setInterval(() => db.ref('counter/currentTime').transaction(t => (t||0)+1), 1000);
        } else {
            clearInterval(timerInterval); timerInterval = null;
            if(action === 'reset') db.ref('counter/currentTime').set(0);
        }
    }

    function adjustTime(sec) {
        db.ref('counter/currentTime').transaction(t => Math.max(0, (t||0)+sec));
    }

    function jumpToTime(timeStr) {
        const p = timeStr.split(':');
        db.ref('counter/currentTime').set(parseInt(p[0])*60 + parseInt(p[1]));
    }

    // --- „É°„É¢‰ΩúÊàê„ÉªÁ∑®ÈõÜ ---
    function setCurrentTimestamp() {
        db.ref('counter/currentTime').once('value', (snap) => {
            const t = snap.val() || 0;
            const m = Math.floor(t/60); const s = t%60;
            document.getElementById('inTime').value = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            showTab('edit');
            document.getElementById('inTitle').focus();
        });
    }

    function setTmpl(val) {
        document.getElementById('inTitle').value = val;
        document.getElementById('inDuration').value = (val === '„Äê„Çπ„ÉÜ„Éº„Ç∏„ÇÆ„Éü„ÉÉ„ÇØ„Äë') ? 20 : 3;
    }

    function saveMemo() {
        const content = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        if(!timeStr || !title) return;

        const data = {
            timeStr,
            timeSec: (parseInt(timeStr.split(':')[0])*60) + parseInt(timeStr.split(':')[1]),
            title,
            duration: parseInt(document.getElementById('inDuration').value) || 3,
            detail: document.getElementById('inDetail').value
        };

        if(editingKey) {
            db.ref(`savedMemos/${content}/${editingKey}`).update(data);
            cancelEdit();
        } else {
            db.ref(`savedMemos/${content}`).push(data);
        }

        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        document.getElementById('inDetail').value = "";
        showTab('remote');
    }

    function editMemo(key, m) {
        editingKey = key;
        document.getElementById('inTime').value = m.timeStr;
        document.getElementById('inTitle').value = m.title;
        document.getElementById('inDuration').value = m.duration;
        document.getElementById('inDetail').value = m.detail || "";
        document.getElementById('btn-save-main').innerText = "üíæ Êõ¥Êñ∞„Åô„Çã";
        document.getElementById('btn-cancel-edit').style.display = "block";
        showTab('edit');
    }

    function cancelEdit() {
        editingKey = null;
        document.getElementById('btn-save-main').innerText = "„É°„É¢„ÇíËøΩÂä†";
        document.getElementById('btn-cancel-edit').style.display = "none";
        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        showTab('remote');
    }

    // --- „É™„Çπ„ÉàË°®Á§∫ ---
    function loadMemos(id) {
        db.ref(`savedMemos/${id}`).off();
        db.ref(`savedMemos/${id}`).on('value', (snap) => {
            const listDiv = document.getElementById('memoList');
            listDiv.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.entries(data).sort((a,b) => a[1].timeSec - b[1].timeSec).forEach(([key, m]) => {
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `
                    <div class="memo-info" onclick="jumpToTime('${m.timeStr}')">
                        <b>[${m.timeStr}]</b> <span>${m.title}</span>
                        <small>„Çø„ÉÉ„Éó„Åß„Ç∏„É£„É≥„Éó / Ë©≥Á¥∞: ${m.detail || '„Å™„Åó'}</small>
                    </div>
                    <div style="display:flex;">
                        <button class="btn-edit" onclick='editMemo("${key}", ${JSON.stringify(m).replace(/"/g, '&quot;')})'>Á∑®</button>
                        <button class="btn-edit" style="background:#444;" onclick="if(confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) db.ref('savedMemos/${id}/${key}').remove()">Ê∂à</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        });
    }

    function clearAllMemos() {
        const id = document.getElementById('contentSelect').value;
        if(confirm("„Åì„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„É°„É¢„ÇíÂÖ®„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) db.ref(`savedMemos/${id}`).remove();
    }
</script>
</body>
</html>