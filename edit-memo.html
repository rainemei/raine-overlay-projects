<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Controller Pro v9.1 (Content Linked Counters)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        body { font-family: sans-serif; background: #111; color: white; padding: 0; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .fixed-header { flex-shrink: 0; background: #222; z-index: 1000; border-bottom: 1px solid #444; }
        
        /* ã‚¿ãƒ– */
        .tabs { display: flex; border-bottom: 1px solid #444; }
        .tab-btn { flex: 1; background: #222; color: #888; border: none; padding: 15px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: #333; color: #00ffff; border-bottom: 3px solid #00ffff; }

        /* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒãƒ¼ */
        .counter-bar { display: flex; justify-content: center; gap: 20px; background: #1a1a1a; padding: 8px 0; border-bottom: 1px solid #333; }
        .counter-item { display: flex; align-items: center; gap: 10px; }
        .counter-btn { width: 30px; height: 30px; background: #444; color: white; border: none; border-radius: 4px; }

        /* ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
        .quick-actions { display: flex; gap: 8px; padding: 10px; background: #222; }
        .btn-main { padding: 15px; font-size: 16px; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; }
        .btn-battle-start { background: #ff8c00; color: white; flex: 1.5; } /* æˆ¦é—˜é–‹å§‹ãƒœã‚¿ãƒ³ */
        .btn-record { background: #17a2b8; color: white; flex: 1.5; }
        .btn-finalize { background: #dc3545; color: white; flex: 1; }

        /* ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .sticky-sub-header { flex-shrink: 0; background: #111; border-bottom: 2px solid #444; padding: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10; }
        .scroll-list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }

        /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
        .timer-display { text-align: center; font-family: monospace; font-size: 48px; color: #00ffff; margin: 10px 0; }

        /* ãƒ‘ãƒ¬ãƒƒãƒˆ */
        .palette-area { background: #222; padding: 8px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .palette-group { margin-bottom: 6px; display: flex; flex-wrap: wrap; gap: 4px; align-items: center; }
        .group-label { font-size: 11px; color: #aaa; width: 45px; font-weight: bold; }
        .tag-btn { padding: 5px 10px; font-size: 12px; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .tag-tnk { border-left: 3px solid #4682b4; }
        .tag-hlr { border-left: 3px solid #2e8b57; }
        .tag-dps { border-left: 3px solid #b22222; }

        /* MOVIEã‚¿ãƒ–èª¿æ•´ */
        .movie-top-area { flex-shrink: 0; background: #000; padding: 5px; text-align: center; }
        #player-container { width: 100%; max-width: 1000px; height: 45vh; aspect-ratio: 16/9; margin: 0 auto; background: #000; }

        /* ãƒ¡ãƒ¢ã‚¢ã‚¤ãƒ†ãƒ  */
        .memo-item { background: #2a2a2a; padding: 10px; margin-bottom: 6px; border-radius: 8px; display: flex; align-items: center; border-left: 5px solid #ffd700; }
        .memo-item.active-now { background: #3a3a10; border-left-color: #00ffff; }
        .memo-info { flex-grow: 1; cursor: pointer; font-size: 14px; }
        .btn-group { display: flex; gap: 4px; }
        .btn-sm { width: 35px; height: 35px; background: #444; color: white; font-size: 12px; border: none; border-radius: 4px; }
        .btn-copy { background: #6a5acd; }
        .btn-paste { background: #20b2aa; }
        .btn-del { background: #dc3545; }
        .dur-btn { background: #555; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; border: none; }

        .tab-pane { display: none; height: 100%; flex-direction: column; overflow: hidden; }
        .tab-pane.active { display: flex; }
        input, select, textarea { width: 100%; margin-bottom: 8px; background: #333; border: 1px solid #555; color: white; padding: 10px; box-sizing: border-box; border-radius: 4px; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div class="tabs">
        <button id="tabBtn-remote" class="tab-btn active" onclick="showTab('remote')">REMOTE</button>
        <button id="tabBtn-edit" class="tab-btn" onclick="showTab('edit')">EDIT</button>
        <button id="tabBtn-movie" class="tab-btn" onclick="showTab('movie')">ğŸ¥ MOVIE</button>
        <button id="tabBtn-manage" class="tab-btn" onclick="showTab('manage')">MANAGE</button>
    </div>
    <div class="counter-bar">
        <div class="counter-item">SET: <button class="counter-btn" onclick="addCounter('setCount', -1)">-</button><span id="display-setCount">1</span><button class="counter-btn" onclick="addCounter('setCount', 1)">+</button></div>
        <div class="counter-item" style="border-left:1px solid #444; padding-left:20px;">PULL: <button class="counter-btn" onclick="addCounter('pullCount', -1)">-</button><span id="display-pullCount">0</span><button class="counter-btn" onclick="addCounter('pullCount', 1)">+</button></div>
    </div>
    <div class="quick-actions">
        <button class="btn-main btn-battle-start" onclick="startBattle()">âš”ï¸ æˆ¦é—˜é–‹å§‹</button>
        <button class="btn-main btn-record" onclick="setCurrentTimestamp()">ğŸ¬ è¨˜éŒ²</button>
        <button class="btn-main btn-finalize" onclick="finalizeLastDuration()">â±ï¸ ç¢ºå®š</button>
    </div>
    <div id="status-msg" style="font-size:11px; color:#aaa; text-align:center; padding-bottom:5px; height:15px; background:#222;"></div>
</div>

<div style="flex-grow:1; overflow:hidden; display:flex; flex-direction:column;">
    <div id="pane-remote" class="tab-pane active">
        <div class="sticky-sub-header">
            <div class="timer-display" id="remoteTimer">00:00</div>
            <div style="display: flex; gap: 8px;">
                <button style="flex:1; background:#444; color:white; padding:15px; font-weight:bold;" onclick="controlTimer('start')">START</button>
                <button style="flex:1; background:#ffc107; padding:15px; font-weight:bold;" onclick="controlTimer('stop')">STOP</button>
                <button style="flex:1; background:#dc3545; color:white; padding:15px; font-weight:bold;" onclick="controlTimer('reset')">RESET</button>
            </div>
        </div>
        <div class="scroll-list-container"><div id="memoListRemote"></div></div>
    </div>

    <div id="pane-edit" class="tab-pane">
        <div class="sticky-sub-header">
            <div class="palette-area">
                <div class="palette-group">
                    <button class="tag-btn" style="background:#fff; color:#000; font-weight:bold;" onclick="addTitle('ã€å…¨ä½“æ”»æ’ƒã€‘')">å…¨ä½“</button>
                    <button class="tag-btn" style="background:#fff; color:#000; font-weight:bold;" onclick="addTitle('ã€æ•£é–‹ã€‘')">æ•£é–‹</button>
                    <button class="tag-btn" style="background:#fff; color:#000; font-weight:bold;" onclick="addTitle('ã€å¼·æ”»æ’ƒã€‘')">å¼·æ”»æ’ƒ</button>
                    <button class="tag-btn" style="background:#fff; color:#000; font-weight:bold;" onclick="addTitle('ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚®ãƒŸãƒƒã‚¯ã€‘')">ã‚¹ãƒ†ãƒ¼ã‚¸</button>
                </div>
                <div class="palette-group">
                    <span class="group-label">èª°ã«</span>
                    <button class="tag-btn tag-tnk" onclick="addTag('MT')">MT</button>
                    <button class="tag-btn tag-tnk" onclick="addTag('ST')">ST</button>
                    <button class="tag-btn tag-hlr" onclick="addTag('PH')">PH</button>
                    <button class="tag-btn tag-hlr" onclick="addTag('BH')">BH</button>
                    <button class="tag-btn tag-dps" onclick="addTag('D1')">D1</button>
                    <button class="tag-btn tag-dps" onclick="addTag('D2')">D2</button>
                    <button class="tag-btn tag-dps" onclick="addTag('D3')">D3</button>
                    <button class="tag-btn tag-dps" onclick="addTag('D4')">D4</button>
                    <button class="tag-btn" onclick="addTag('ãƒ©ãƒ³ã‚¿ã‚²')">ãƒ©ãƒ³ã‚¿ã‚²</button>
                </div>
                <div class="palette-group">
                    <span class="group-label">ç¨®é¡</span>
                    <button class="tag-btn" onclick="addTag('å¼·æ”»æ’ƒ')">å¼·</button>
                    <button class="tag-btn" onclick="addTag('é ­å‰²')">é ­å‰²</button>
                    <button class="tag-btn" onclick="addTag('è·é›¢æ¸›è¡°')">è·é›¢</button>
                    <button class="tag-btn" onclick="addTag('å¡”')">å¡”</button>
                    <button class="tag-btn" onclick="addTag('æ‰‡ç¯„å›²')">æ‰‡</button>
                    <button class="tag-btn" onclick="addTag('å††ç¯„å›²')">å††</button>
                    <button class="tag-btn" onclick="addTag('ãƒ‰ãƒ¼ãƒŠãƒ„ç¯„å›²')">ãƒ‰ãƒ¼ãƒŠãƒ„</button>
                    <button class="tag-btn" onclick="addTag('ç›´ç·šç¯„å›²')">ç›´ç·š</button>
                    <button class="tag-btn" onclick="addTag('ãƒãƒƒã‚¯ãƒãƒƒã‚¯')">KB</button>
                    <button class="tag-btn" onclick="addTag('ç·šä¼¸ã°ã—')">ç·šä¼¸</button>
                </div>
                <div class="palette-group">
                    <span class="group-label">çŠ¶æ…‹</span>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('DoT')">DoT</button>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('è¢«ãƒ€ãƒ¡å¢—')">ãƒ€ãƒ¡å¢—</button>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('ä¸æ¸›')">ä¸æ¸›</button>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('ã‚¹ã‚¿ãƒ³')">ã‚¹ã‚¿ãƒ³</button>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('è¢«å›å¾©æ¸›')">è¢«å›å¾©æ¸›</button>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('ä¸å›å¾©æ¸›')">ä¸å›å¾©æ¸›</button>
                    <button class="tag-btn" style="background:#4b0082;" onclick="addTag('æ­»ã®å®£å‘Š')">å®£å‘Š</button>
                </div>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="inTime" placeholder="00:00" style="width:80px;">
                <input type="text" id="inTitle" placeholder="æŠ€å" style="flex-grow:1;">
                <input type="number" id="inDuration" style="width:60px;" value="3">
            </div>
            <textarea id="inDetail" placeholder="è©³ç´°ãƒ¡ãƒ¢" rows="2"></textarea>
            <button id="btn-save-main" style="background:#007bff; color:white; width:100%; padding:12px; font-weight:bold;" onclick="saveMemo()">ğŸ’¾ ä¿å­˜ / æ›´æ–°</button>
            <button id="btn-cancel-edit" style="display:none; background:#666; width:100%; margin-top:5px; padding:8px;" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <div class="scroll-list-container"><div id="memoList"></div></div>
    </div>

    <div id="pane-movie" class="tab-pane">
        <div class="movie-top-area">
            <input type="text" id="ytUrl" placeholder="YouTube URLã‚’è²¼ã‚Šä»˜ã‘" onchange="loadVideo()">
            <div id="player-container"><div id="player"></div></div>
            <button style="width:100%; background:#dc3545; color:white; padding:10px; font-weight:bold;" onclick="setVideoStartOffset()">ğŸš© ã“ã“ã‚’æˆ¦é—˜é–‹å§‹(0ç§’)ã«ã™ã‚‹</button>
        </div>
        <div class="scroll-list-container"><div id="memoListMovie"></div></div>
    </div>

    <div id="pane-manage" class="tab-pane">
        <div class="scroll-list-container">
            <select id="contentSelect" onchange="changeContent()"></select>
            <button style="background:#007bff; color:white; width:100%; padding:15px; margin-bottom:10px;" onclick="addContentName()">ï¼‹ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¿½åŠ </button>
            <button style="background:#dc3545; color:white; width:100%; padding:15px;" onclick="clearAllMemos()">âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤</button>
            <label style="display:block; margin-top:20px; font-size:18px;"><input type="checkbox" id="autoScroll" checked> AUTOã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</label>
        </div>
    </div>
</div>

<script>
    // Firebaseè¨­å®šï¼ˆã”è‡ªèº«ã®ã‚‚ã®ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentSec = 0, videoOffset = 0, editingKey = null, lastMemoKey = null, timerInterval = null, player, clipboardMemo = null;

    // --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ç´ä»˜ã„ãŸã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ“ä½œ ---
    function addCounter(type, val) {
        const id = document.getElementById('contentSelect').value;
        if (!id) return;
        // ä¿å­˜å…ˆã‚’ savedMemos/[ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ID]/counters/[type] ã«å¤‰æ›´
        db.ref(`savedMemos/${id}/counters/${type}`).transaction(c => Math.max(0, (c || 0) + val));
    }

    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
    let counterRefs = { set: null, pull: null };

    function syncCounters(id) {
        // å‰ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
        if (counterRefs.set) counterRefs.set.off();
        if (counterRefs.pull) counterRefs.pull.off();

        // æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ç›£è¦–
        counterRefs.set = db.ref(`savedMemos/${id}/counters/setCount`);
        counterRefs.set.on('value', s => document.getElementById('display-setCount').innerText = s.val() || 1);

        counterRefs.pull = db.ref(`savedMemos/${id}/counters/pullCount`);
        counterRefs.pull.on('value', s => document.getElementById('display-pullCount').innerText = s.val() || 0);
    }

    // --- æˆ¦é—˜é–‹å§‹ ---
    function startBattle() {
        // 1. PULLã‚’+1
        addCounter('pullCount', 1);
        // 2. ã‚¿ã‚¤ãƒãƒ¼ã‚’0ã«ãƒªã‚»ãƒƒãƒˆ
        db.ref('counter/currentTime').set(0);
        // 3. ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ
        controlTimer('start');
        
        document.getElementById('status-msg').innerText = "âš”ï¸ æˆ¦é—˜é–‹å§‹ï¼ˆPULLæ›´æ–° & ã‚¿ã‚¤ãƒãƒ¼å§‹å‹•ï¼‰";
    }

    // ã‚¿ã‚¤ãƒãƒ¼ã¯å…±æœ‰ã®ã¾ã¾ï¼ˆåŒæœŸç”¨ï¼‰
    db.ref('counter/currentTime').on('value', snap => {
        currentSec = snap.val() || 0;
        document.getElementById('remoteTimer').innerText = formatTime(currentSec);
        if(document.getElementById('autoScroll').checked) autoScrollToList(currentSec);
    });

    // --- ãã®ä»–åŸºæœ¬æ©Ÿèƒ½ ---
    function formatTime(sec) {
        const m = Math.floor(sec / 60), s = sec % 60;
        return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-pane, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tabBtn-' + tabId).classList.add('active');
        document.getElementById('pane-' + tabId).classList.add('active');
    }

    function changeContent() {
        const id = document.getElementById('contentSelect').value;
        if(id) {
            db.ref('activeContentID').set(id);
            loadMemos(id);
            syncCounters(id); // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åŒæœŸå…ˆã‚’åˆ‡ã‚Šæ›¿ãˆ
        }
    }

    // ãƒªã‚¹ãƒˆå–å¾—
    function loadMemos(id) {
        db.ref(`savedMemos/${id}`).off();
        // counters ä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¡ãƒ¢ã¨ã—ã¦è¡¨ç¤º
        db.ref(`savedMemos/${id}`).on('value', snap => {
            const allData = snap.val() || {};
            const listHTML = Object.entries(allData)
                .filter(([key]) => key !== 'counters') // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–
                .sort((a,b) => a[1].timeSec - b[1].timeSec)
                .map(([key, m]) => `
                <div class="memo-item" data-sec="${m.timeSec}">
                    <div class="memo-info" onclick="db.ref('counter/currentTime').set(${m.timeSec})">
                        <b>[${m.timeStr}]</b> ${m.title} 
                        <span class="dur-adjust">(${m.duration}s) 
                            <button class="dur-btn" onclick="adjustDuration('${key}', 1); event.stopPropagation();">+</button>
                            <button class="dur-btn" onclick="adjustDuration('${key}', -1); event.stopPropagation();">-</button>
                        </span>
                        <br><small style="color:#aaa;">${m.detail || ''}</small>
                    </div>
                    <div class="btn-group">
                        <button class="btn-sm btn-copy" onclick='copyContent(${JSON.stringify(m).replace(/"/g, '&quot;')})'>ã‚³</button>
                        <button class="btn-sm btn-paste" onclick='pasteContent("${key}")'>è²¼</button>
                        <button class="btn-sm" onclick='editMemo("${key}", ${JSON.stringify(m).replace(/"/g, '&quot;')})'>ç·¨</button>
                        <button class="btn-sm btn-del" onclick='deleteMemo("${key}")'>å‰Š</button>
                    </div>
                </div>`).join("");
            document.getElementById('memoList').innerHTML = listHTML;
            document.getElementById('memoListRemote').innerHTML = listHTML;
            document.getElementById('memoListMovie').innerHTML = listHTML;
        });
    }

    // --- æ—¢å­˜ã®é–¢æ•°ç¾¤ ---
    function controlTimer(action) {
        if(action === 'start'){
            if(timerInterval) return;
            timerInterval = setInterval(() => db.ref('counter/currentTime').transaction(t => (t||0)+1), 1000);
        } else {
            clearInterval(timerInterval); timerInterval = null;
            if(action === 'reset') db.ref('counter/currentTime').set(0);
        }
    }

    // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ“ä½œ
    function saveMemo() {
        const id = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        if(!timeStr || !title) return;
        const timeSec = timeStr.split(':').reduce((acc, t) => (60 * acc) + +t);
        const data = { timeStr, timeSec, title, duration: parseInt(document.getElementById('inDuration').value)||3, detail: document.getElementById('inDetail').value };
        if(editingKey) db.ref(`savedMemos/${id}/${editingKey}`).update(data);
        else db.ref(`savedMemos/${id}`).push(data);
        cancelEdit();
    }

    function editMemo(key, m) {
        editingKey = key;
        document.getElementById('inTime').value = m.timeStr;
        document.getElementById('inTitle').value = m.title;
        document.getElementById('inDuration').value = m.duration;
        document.getElementById('inDetail').value = m.detail || "";
        document.getElementById('btn-save-main').innerText = "ğŸ’¾ æ›´æ–°ã™ã‚‹";
        document.getElementById('btn-cancel-edit').style.display = "block";
        showTab('edit');
    }

    function cancelEdit() {
        editingKey = null;
        document.getElementById('inTitle').value = ""; document.getElementById('inDetail').value = "";
        document.getElementById('btn-save-main').innerText = "ğŸ’¾ ä¿å­˜";
        document.getElementById('btn-cancel-edit').style.display = "none";
    }

    function deleteMemo(key) {
        if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) db.ref(`savedMemos/${document.getElementById('contentSelect').value}/${key}`).remove();
    }

    function adjustDuration(key, diff) {
        db.ref(`savedMemos/${document.getElementById('contentSelect').value}/${key}/duration`).transaction(d => Math.max(1, (d || 3) + diff));
    }

    function addTag(tag) {
        const area = document.getElementById('inDetail');
        area.value += (area.value ? " " : "") + `[${tag}]`;
        area.focus();
    }

    function addTitle(title) {
        const area = document.getElementById('inTitle');
        // ã™ã§ã«æ–‡å­—ãŒã‚ã‚‹å ´åˆã¯åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’æŒŸã‚€
        area.value += (area.value ? " " : "") + title;
        area.focus();
    }

    function setCurrentTimestamp() {
        const id = document.getElementById('contentSelect').value;
        const newRef = db.ref(`savedMemos/${id}`).push({ timeStr: formatTime(currentSec), timeSec: currentSec, title: "ï¼ˆè¨˜éŒ²æ¸ˆï¼‰", duration: 3, detail: "" });
        lastMemoKey = newRef.key;
        document.getElementById('status-msg').innerText = `è¨˜éŒ²: ${formatTime(currentSec)}`;
    }

    function finalizeLastDuration() {
        if (!lastMemoKey) return;
        const id = document.getElementById('contentSelect').value;
        db.ref(`savedMemos/${id}/${lastMemoKey}`).once('value', snap => {
            const data = snap.val();
            if (data) {
                const dur = Math.max(1, currentSec - data.timeSec);
                db.ref(`savedMemos/${id}/${lastMemoKey}`).update({ duration: dur });
                document.getElementById('status-msg').innerText = `ç¢ºå®š: ${dur}ç§’`;
            }
        });
    }

    function copyContent(m) {
        clipboardMemo = { title: m.title, duration: m.duration, detail: m.detail || "" };
        document.getElementById('status-msg').innerText = `ã‚³ãƒ”ãƒ¼å®Œäº†: ${m.title}`;
    }

    function pasteContent(key) {
        if (!clipboardMemo) return;
        db.ref(`savedMemos/${document.getElementById('contentSelect').value}/${key}`).update(clipboardMemo);
        document.getElementById('status-msg').innerText = `è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ`;
    }

    // YouTube
    var ytTag = document.createElement('script'); ytTag.src = "https://www.youtube.com/iframe_api";
    document.getElementsByTagName('script')[0].parentNode.insertBefore(ytTag, null);
    function loadVideo() {
        const url = document.getElementById('ytUrl').value;
        let vid = url.includes('v=') ? url.split('v=')[1].split('&')[0] : (url.includes('/live/') ? url.split('/live/')[1].split('?')[0] : url.split('/').pop());
        if (player) player.loadVideoById(vid);
        else player = new YT.Player('player', { height:'100%', width:'100%', videoId: vid });
    }
    function syncTimerWithVideo() {
        if (player && player.getPlayerState?.() === YT.PlayerState.PLAYING) {
            const relTime = Math.max(0, Math.floor(player.getCurrentTime()) - videoOffset);
            if (Math.abs(relTime - currentSec) > 1) db.ref('counter/currentTime').set(relTime);
        }
        requestAnimationFrame(syncTimerWithVideo);
    }
    requestAnimationFrame(syncTimerWithVideo);
    function setVideoStartOffset() {
        videoOffset = Math.floor(player.getCurrentTime());
        db.ref('counter/currentTime').set(0);
    }

    // ç®¡ç†ãƒ»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    function addContentName() {
        const name = prompt("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å:");
        if (name) db.ref('contentsList').push(name);
    }

    db.ref('contentsList').on('value', snap => {
        const select = document.getElementById('contentSelect');
        const current = select.value;
        select.innerHTML = "";
        Object.entries(snap.val() || {}).forEach(([id, name]) => {
            const opt = document.createElement('option'); opt.value = id; opt.innerText = name;
            select.appendChild(opt);
        });
        if(current && select.querySelector(`option[value="${current}"]`)) select.value = current;
        changeContent();
    });

    function autoScrollToList(sec) {
        const items = document.querySelectorAll('.tab-pane.active .memo-item');
        let target = null;
        items.forEach(el => {
            el.classList.remove('active-now');
            if(parseInt(el.getAttribute('data-sec')) <= sec) target = el;
        });
        if(target) { target.classList.add('active-now'); target.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }
    function clearAllMemos() { if(confirm("æ¶ˆå»ï¼Ÿ")) db.ref(`savedMemos/${document.getElementById('contentSelect').value}`).remove(); }
</script>
</body>
</html>