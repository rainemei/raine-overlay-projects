<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; padding: 10px; margin: 0; }
        .timer-box { background: #333; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 10px; position: sticky; top: 0; z-index: 10; }
        #timerDisplay { font-size: 32px; font-family: monospace; color: #00ffff; }
        
        /* 入力フォーム */
        .input-card { background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #444; }
        .input-card input, .input-card textarea { width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; box-sizing: border-box; }
        
        /* リスト */
        .memo-item { display: flex; background: #2a2a2a; margin-bottom: 8px; border-radius: 8px; align-items: center; border-left: 5px solid #666; }
        .memo-info { flex-grow: 1; padding: 10px; }
        .memo-time { color: #ffd700; font-weight: bold; font-family: monospace; }
        .memo-title { font-weight: bold; font-size: 16px; margin-bottom: 4px; }
        .memo-detail { font-size: 13px; color: #aaa; white-space: pre-wrap; }
        
        #editOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 100; flex-direction: column; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="timer-box">
        <div id="timerDisplay">00:00.0</div>
        <button onclick="startTimer()">START</button> <button onclick="stopTimer()">STOP</button> <button onclick="resetTimer()">RESET</button>
    </div>

    <div class="input-card">
        <div style="display:flex; gap:5px;">
            <input type="text" id="inTime" placeholder="00:00" style="width:70px;">
            <input type="text" id="inTitle" placeholder="概要（例：塔ギミック）">
        </div>
        <textarea id="inDetail" placeholder="詳細（例：D1→北、D2→東...）" rows="3"></textarea>
        <button onclick="addMemo()" style="width:100%; padding:10px; background:#28a745; color:white; border:none; border-radius:5px;">ギミック追加</button>
    </div>

    <div id="memoList"></div>
    <a href="index.html" style="display:block; text-align:center; padding:20px; color:#aaa;">← HUBに戻る</a>

    <script>
        // ★Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
            authDomain: "raine-overlay-projects.firebaseapp.com",
            databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "raine-overlay-projects",
            storageBucket: "raine-overlay-projects.firebasestorage.app",
            messagingSenderId: "116002218964",
            appId: "1:116002218964:web:616f3503eaebacb4442c41"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let elapsed = 0, timerInterval;

        // ストップウォッチ (currentTimeを秒単位でFirebaseへ)
        function startTimer() {
            let start = Date.now() - elapsed;
            timerInterval = setInterval(() => {
                elapsed = Date.now() - start;
                document.getElementById('timerDisplay').innerText = formatTime(elapsed);
                db.ref('counter/currentTime').set(Math.floor(elapsed / 1000));
            }, 100);
        }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { stopTimer(); elapsed = 0; document.getElementById('timerDisplay').innerText="00:00.0"; db.ref('counter/currentTime').set(0); }
        function formatTime(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        function addMemo() {
            const time = document.getElementById('inTime').value || "00:00";
            const title = document.getElementById('inTitle').value;
            const detail = document.getElementById('inDetail').value;
            if(!title) return;
            
            // 秒数に変換して保存
            const parts = time.split(':');
            const totalSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);

            db.ref('counter/savedMemos').push({
                timeStr: time,
                timeSec: totalSec,
                title: title,
                detail: detail
            });
            document.getElementById('inTitle').value = ""; document.getElementById('inDetail').value = "";
        }

        // リスト表示
        db.ref('counter').on('value', (s) => {
            const data = s.val() || {};
            const listDiv = document.getElementById('memoList');
            listDiv.innerHTML = "";
            const saved = data.savedMemos || {};
            
            Object.keys(saved).sort((a,b) => saved[a].timeSec - saved[b].timeSec).forEach(key => {
                const m = saved[key];
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `
                    <div class="memo-info">
                        <div class="memo-time">[${m.timeStr}]</div>
                        <div class="memo-title">${m.title}</div>
                        <div class="memo-detail">${m.detail}</div>
                    </div>
                    <button onclick="deleteMemo('${key}')" style="background:none; color:red; border:none; padding:10px;">×</button>
                `;
                listDiv.appendChild(item);
            });
        });
        function deleteMemo(key) { if(confirm('削除？')) db.ref('counter/savedMemos/'+key).remove(); }
    </script>
</body>
</html>

