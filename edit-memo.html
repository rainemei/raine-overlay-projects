<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Editor v2</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: white; padding: 10px; margin: 0; }
        .input-card { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        input, select, textarea { width: 100%; margin-bottom: 10px; background: #444; border: 1px solid #555; color: white; padding: 12px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin-bottom: 5px; }
        .btn-save { background: #28a745; color: white; }
        .btn-clear { background: #dc3545; color: white; font-size: 12px; }
        .tmpl-btn { background: #555; color: white; margin: 2px; width: auto; font-size: 12px; display: inline-block; padding: 8px 12px; }
        .memo-item { background: #444; padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ffd700; }
        .memo-info { display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div class="input-card">
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="contentSelect" onchange="changeContent()" style="margin-bottom:0; flex-grow:1;"></select>
        <button onclick="addContentName()" style="width:auto; background:#007bff; color:white; margin:0;">ï¼‹è¿½åŠ </button>
    </div>

    <button onclick="document.getElementById('tmplBox').style.display='block'" style="font-size:12px; background:#444;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
    <div id="tmplBox" style="display:none; background:rgba(0,0,0,0.8); position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; padding:20px; box-sizing:border-box;">
        <div style="background:#333; padding:20px; border-radius:10px;">
            <h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</h3>
            <button class="tmpl-btn" onclick="setTmpl('ã€å…¨ä½“æ”»æ’ƒã€‘')">å…¨ä½“</button>
            <button class="tmpl-btn" onclick="setTmpl('ã€æ•£é–‹ã€‘')">æ•£é–‹</button>
            <button class="tmpl-btn" onclick="setTmpl('ã€å¼·æ”»æ’ƒã€‘')">å¼·æ”»æ’ƒ</button>
            <button class="tmpl-btn" onclick="setTmpl('ã€é ­å‰²ã‚Šã€‘')">é ­å‰²ã‚Š</button>
            <button class="tmpl-btn" onclick="setTmpl('ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚®ãƒŸãƒƒã‚¯ã€‘')">ã‚¹ãƒ†ãƒ¼ã‚¸</button>
            <button onclick="document.getElementById('tmplBox').style.display='none'" style="margin-top:20px; background:#666;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div style="display:flex; gap:5px;">
        <input type="text" id="inTime" placeholder="00:00" style="width:100px;">
        <input type="text" id="inTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="flex-grow:1;">
        <input type="number" id="inDuration" value="3" style="width:70px;">
    </div>
    <textarea id="inDetail" placeholder="è©³ç´°ãƒ¡ãƒ¢" rows="2"></textarea>
    <button class="btn-save" onclick="saveMemo()">ãƒ¡ãƒ¢ã‚’è¿½åŠ </button>
    <button class="btn-clear" onclick="clearAllMemos()">ã‚ªãƒ¼ãƒ«ã‚¯ãƒªã‚¢</button>

    <div style="text-align: center; margin-bottom: 10px;">
        <span id="remoteTimer" style="font-family: monospace; font-size: 32px; color: #00ffff;">00:00</span>
    </div>
    <div style="display: flex; gap: 5px;">
        <button onclick="controlTimer('start')" style="background: #28a745;">START</button>
        <button onclick="controlTimer('stop')" style="background: #ffc107; color: black;">STOP</button>
        <button onclick="controlTimer('reset')" style="background: #dc3545;">RESET</button>
    </div>
    <div style="display: flex; gap: 5px; margin-top: 5px;">
        <button onclick="adjustTime(-5)" style="background: #555;">-5ç§’</button>
        <button onclick="adjustTime(5)" style="background: #555;">+5ç§’</button>
    </div>

    <button onclick="setCurrentTimestamp()" style="background: #17a2b8; margin-bottom: 10px;">ğŸ•’ ç¾åœ¨æ™‚åˆ»ã‚’ã‚»ãƒƒãƒˆ</button>

</div>

<div id="memoList" style="padding:10px;"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿
    db.ref('contentsList').on('value', (snapshot) => {
        const list = snapshot.val() || { "default": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ" };
        const select = document.getElementById('contentSelect');
        const lastVal = select.value;
        select.innerHTML = "";
        Object.entries(list).forEach(([id, name]) => {
            const opt = document.createElement('option'); opt.value = id; opt.innerText = name;
            select.appendChild(opt);
        });
        if(lastVal) select.value = lastVal;
        changeContent();
    });

    function addContentName() {
        const name = prompt("æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å");
        if(name) db.ref(`contentsList/ID_${Date.now()}`).set(name);
    }

    function changeContent() {
        const contentId = document.getElementById('contentSelect').value;
        db.ref('activeContentID').set(contentId); // OBSå´ã«é€šçŸ¥
        loadMemos(contentId);
    }

    function setTmpl(val) {
        document.getElementById('inTitle').value = val;
        document.getElementById('inDuration').value = (val === 'ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚®ãƒŸãƒƒã‚¯ã€‘') ? 20 : 3;
        document.getElementById('tmplBox').style.display = 'none';
    }

    function saveMemo() {
        const content = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        if(!timeStr || !title) return;
        
        db.ref(`savedMemos/${content}`).push({
            timeStr,
            timeSec: (parseInt(timeStr.split(':')[0])*60) + parseInt(timeStr.split(':')[1]),
            title,
            duration: parseInt(document.getElementById('inDuration').value) || 3,
            detail: document.getElementById('inDetail').value
        });
        document.getElementById('inTitle').value = "";
        document.getElementById('inDetail').value = "";
    }

    function loadMemos(contentId) {
        db.ref(`savedMemos/${contentId}`).off();
        db.ref(`savedMemos/${contentId}`).on('value', (snap) => {
            const listDiv = document.getElementById('memoList');
            listDiv.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.entries(data).sort((a,b) => a[1].timeSec - b[1].timeSec).forEach(([key, m]) => {
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `<div><b>[${m.timeStr}]</b> ${m.title}</div><button onclick="db.ref('savedMemos/${contentId}/${key}').remove()" style="width:auto; margin:0; padding:5px 10px; background:#666;">å‰Šé™¤</button>`;
                listDiv.appendChild(item);
            });
        });
    }

    function clearAllMemos() {
        const id = document.getElementById('contentSelect').value;
        if(confirm("ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ¡ãƒ¢ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) db.ref(`savedMemos/${id}`).remove();
    }

    let timerInterval = null;

    // Firebaseã®ã‚¿ã‚¤ãƒãƒ¼ï¼ˆcurrentTimeï¼‰ã‚’ç›£è¦–ã—ã¦è¡¨ç¤º
    db.ref('counter/currentTime').on('value', (snap) => {
        const t = snap.val() || 0;
        const m = Math.floor(t / 60);
        const s = t % 60;
        document.getElementById('remoteTimer').innerText = 
            `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    });

    // ã‚¿ã‚¤ãƒãƒ¼æ“ä½œ
    function controlTimer(action) {
        if (action === 'start') {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                db.ref('counter/currentTime').transaction(t => (t || 0) + 1);
            }, 1000);
        } else if (action === 'stop') {
            clearInterval(timerInterval);
            timerInterval = null;
        } else if (action === 'reset') {
            clearInterval(timerInterval);
            timerInterval = null;
            db.ref('counter/currentTime').set(0);
        }
    }

    // ç§’æ•°èª¿æ•´
    function adjustTime(sec) {
        db.ref('counter/currentTime').transaction(t => {
            const newTime = (t || 0) + sec;
            return newTime < 0 ? 0 : newTime;
        });
    }

    // A. ã€Œä»Šï¼ã€ã®æ™‚é–“ã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆã™ã‚‹
    function setCurrentTimestamp() {
        db.ref('counter/currentTime').once('value', (snap) => {
            const t = snap.val() || 0;
            const m = Math.floor(t / 60);
            const s = t % 60;
            document.getElementById('inTime').value = 
                `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            // ã‚¿ã‚¤ãƒˆãƒ«å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
            document.getElementById('inTitle').focus();
        });
    }

    // B. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ç‰¹å®šä½ç½®ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹
    function jumpToTime(timeStr) {
        const parts = timeStr.split(':');
        const sec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
        db.ref('counter/currentTime').set(sec);
    }

    // C. ãƒ¡ãƒ¢ã®ä¿®æ­£æ©Ÿèƒ½ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
    let editingKey = null; // ä»Šã©ã®ãƒ¡ãƒ¢ã‚’ç·¨é›†ã—ã¦ã„ã‚‹ã‹

    function editMemo(key, data) {
        editingKey = key;
        document.getElementById('inTime').value = data.timeStr;
        document.getElementById('inTitle').value = data.title;
        document.getElementById('inDuration').value = data.duration || 3;
        document.getElementById('inDetail').value = data.detail || "";
        
        // ä¿å­˜ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’ã€Œæ›´æ–°ã€ã«å¤‰ãˆã‚‹
        const saveBtn = document.querySelector('.btn-save');
        saveBtn.innerText = "ğŸ’¾ ãƒ¡ãƒ¢ã‚’æ›´æ–°";
        saveBtn.style.background = "#007bff";
        
        // å…¥åŠ›æ¬„ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // D. ä¿å­˜ãƒ»æ›´æ–°å‡¦ç†ã®çµ±åˆ
    function saveMemo() {
        const content = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        if(!timeStr || !title) return;

        const memoData = {
            timeStr,
            timeSec: (parseInt(timeStr.split(':')[0])*60) + parseInt(timeStr.split(':')[1]),
            title,
            duration: parseInt(document.getElementById('inDuration').value) || 3,
            detail: document.getElementById('inDetail').value
        };

        if (editingKey) {
            // æ›´æ–°å‡¦ç†
            db.ref(`savedMemos/${content}/${editingKey}`).update(memoData);
            editingKey = null;
            document.querySelector('.btn-save').innerText = "ãƒ¡ãƒ¢ã‚’è¿½åŠ ";
            document.querySelector('.btn-save').style.background = "#28a745";
        } else {
            // æ–°è¦è¿½åŠ 
            db.ref(`savedMemos/${content}`).push(memoData);
        }

        // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        document.getElementById('inDetail').value = "";
    }

    // E. ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆè¡¨ç¤ºã®ä¿®æ­£ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã¨ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼‰
    function loadMemos(contentId) {
        db.ref(`savedMemos/${contentId}`).off();
        db.ref(`savedMemos/${contentId}`).on('value', (snap) => {
            const listDiv = document.getElementById('memoList');
            listDiv.innerHTML = "";
            const data = snap.val();
            if(!data) return;

            Object.entries(data).sort((a,b) => a[1].timeSec - b[1].timeSec).forEach(([key, m]) => {
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `
                    <div class="memo-info" onclick="jumpToTime('${m.timeStr}')" style="cursor:pointer; flex-grow:1;">
                        <b style="color:#00ffff;">[${m.timeStr}]</b> ${m.title}
                        <small style="color:#aaa; font-size:10px; display:block;">ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¤ãƒãƒ¼ã‚¸ãƒ£ãƒ³ãƒ—</small>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button onclick='editMemo("${key}", ${JSON.stringify(m).replace(/"/g, '&quot;')})' style="width:auto; background:#bc8f8f; padding:5px;">ç·¨é›†</button>
                        <button onclick="db.ref('savedMemos/${contentId}/${key}').remove()" style="width:auto; background:#666; padding:5px;">å‰Šé™¤</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        });
    }

</script>
</body>
</html>
