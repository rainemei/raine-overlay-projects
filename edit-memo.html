<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Controller Pro v3</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šã€ãƒªã‚¹ãƒˆã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        body { font-family: sans-serif; background: #111; color: white; padding: 0; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .fixed-header { flex-shrink: 0; background: #222; z-index: 1000; border-bottom: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .scroll-content { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }

        /* ã‚¿ãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .tabs { display: flex; border-bottom: 1px solid #444; }
        .tab-btn { flex: 1; background: #222; color: #888; border: none; padding: 15px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: #333; color: #00ffff; border-bottom: 3px solid #00ffff; }

        /* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤º */
        .counter-bar { display: flex; justify-content: center; gap: 20px; background: #1a1a1a; padding: 8px 0; font-size: 14px; border-bottom: 1px solid #333; }
        .counter-item { display: flex; align-items: center; gap: 10px; }
        .counter-btn { width: 35px; height: 35px; background: #444; color: white; border-radius: 4px; font-size: 20px; border: none; display: flex; align-items: center; justify-content: center; }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        .timer-display { text-align: center; font-family: monospace; font-size: 52px; color: #00ffff; margin: 10px 0; text-shadow: 0 0 10px rgba(0,255,255,0.4); }

        /* ã‚¹ã‚¤ãƒƒãƒé¡ */
        .switch-area { display: flex; justify-content: space-around; padding: 12px; background: #2a2a2a; font-size: 13px; border-radius: 8px; margin: 10px; }
        .toggle-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .tab-pane { display: none; padding: 15px; }
        .tab-pane.active { display: block; }
        .input-card { background: #333; padding: 15px; border-radius: 8px; }
        input, select, textarea { width: 100%; margin-bottom: 10px; background: #444; border: 1px solid #555; color: white; padding: 12px; box-sizing: border-box; font-size: 16px; border-radius: 4px; }
        
        button { cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:active { opacity: 0.7; }
        .btn-main { background: #007bff; color: white; width: 100%; padding: 15px; font-size: 18px; }
        .btn-timestamp { background: #17a2b8; color: white; width: calc(100% - 20px); font-size: 20px; margin: 0 10px 15px 10px; padding: 15px; }
        .tmpl-btn { background: #555; color: white; margin: 2px; padding: 8px 12px; font-size: 12px; }

        /* ãƒªã‚¹ãƒˆè¡¨ç¤º */
        .memo-item { background: #2a2a2a; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; border-left: 6px solid #ffd700; transition: background 0.3s, transform 0.2s; }
        .memo-item.active-now { background: #3a3a10; border-left-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.2); transform: scale(1.02); }
        .memo-info { flex-grow: 1; cursor: pointer; }
        .memo-info b { color: #00ffff; font-size: 18px; margin-right: 8px; }
        .memo-info span { font-size: 16px; }
        .memo-info small { display: block; color: #888; font-size: 12px; margin-top: 5px; }
        .btn-sm { width: 45px; height: 45px; background: #444; color: white; margin-left: 5px; font-size: 12px; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div class="tabs">
        <button id="tabBtn-remote" class="tab-btn active" onclick="showTab('remote')">REMOTE</button>
        <button id="tabBtn-edit" class="tab-btn" onclick="showTab('edit')">EDIT</button>
        <button id="tabBtn-manage" class="tab-btn" onclick="showTab('manage')">MANAGE</button>
    </div>

    <div class="counter-bar">
        <div class="counter-item">
            SET: <button class="counter-btn" onclick="addCounter('setCount', -1)">-</button>
            <span id="display-setCount" style="font-size: 20px; font-weight: bold; width: 30px; text-align: center;">1</span>
            <button class="counter-btn" onclick="addCounter('setCount', 1)">+</button>
        </div>
        <div class="counter-item" style="border-left: 1px solid #444; padding-left: 20px;">
            PULL: <button class="counter-btn" onclick="addCounter('pullCount', -1)">-</button>
            <span id="display-pullCount" style="font-size: 20px; font-weight: bold; width: 30px; text-align: center;">0</span>
            <button class="counter-btn" onclick="addCounter('pullCount', 1)">+</button>
        </div>
    </div>

    <div id="pane-remote-head" class="tab-pane active" style="padding: 10px;">
        <div class="timer-display" id="remoteTimer">00:00</div>
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <button style="flex:1; background:#28a745; color:white; padding:15px;" onclick="controlTimer('start')">START</button>
            <button style="flex:1; background:#ffc107; padding:15px;" onclick="controlTimer('stop')">STOP</button>
            <button style="flex:1; background:#dc3545; color:white; padding:15px;" onclick="controlTimer('reset')">RESET</button>
        </div>
        
        <div class="switch-area">
            <label class="toggle-label"><input type="checkbox" id="autoScroll" checked> AUTOã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</label>
            <label class="toggle-label"><input type="checkbox" id="jumpToEdit"> è¨˜éŒ²æ™‚EDITã¸ç§»å‹•</label>
        </div>
    </div>
    
    <button id="btn-quick-record" class="btn-timestamp" onclick="setCurrentTimestamp()">ğŸ•’ ä»Šã®æ™‚é–“ã‚’ã‚¯ã‚¤ãƒƒã‚¯è¨˜éŒ²</button>
</div>

<div class="scroll-content" id="listContainer">
    <div id="pane-edit" class="tab-pane">
        <div class="input-card">
            <div style="margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 4px;">
                <button class="tmpl-btn" onclick="setTmpl('ã€å…¨ä½“æ”»æ’ƒã€‘')">å…¨ä½“</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€å¼·æ”»æ’ƒã€‘')">å¼·æ”»æ’ƒ</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€æ•£é–‹ã€‘')">æ•£é–‹</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€é ­å‰²ã‚Šã€‘')">é ­å‰²ã‚Š</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚®ãƒŸãƒƒã‚¯ã€‘')">ã‚¹ãƒ†ãƒ¼ã‚¸</button>
            </div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="inTime" placeholder="00:00" style="width:110px;">
                <input type="text" id="inTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" style="flex-grow:1;">
            </div>
            <textarea id="inDetail" placeholder="è©³ç´°ãƒ¡ãƒ¢ï¼ˆçœç•¥å¯ï¼‰" rows="2"></textarea>
            <button id="btn-save-main" class="btn-main" onclick="saveMemo()">ğŸ’¾ ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
            <button id="btn-cancel-edit" style="display:none; background:#666; width:100%; margin-top:5px; padding:10px;" onclick="cancelEdit()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="pane-manage" class="tab-pane">
        <div class="input-card">
            <label style="font-size:12px; color:#aaa;">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é¸æŠ</label>
            <div style="display:flex; gap:8px; margin-top:5px;">
                <select id="contentSelect" onchange="changeContent()" style="margin:0;"></select>
                <button onclick="addContentName()" style="width:auto; background:#007bff; color:white; padding:0 20px;">ï¼‹</button>
            </div>
            <button style="background:#dc3545; width:100%; color:white; margin-top:20px; padding:12px;" onclick="clearAllMemos()">âš ï¸ ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚ªãƒ¼ãƒ«ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div id="memoList"></div>
</div>

<script>
    // â˜…Firebaseè¨­å®šï¼ˆã”è‡ªèº«ã®ã‚‚ã®ã«è²¼ã‚Šæ›¿ãˆã¦ãã ã•ã„ï¼‰
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let editingKey = null;
    let timerInterval = null;
    let currentSec = 0;

    // --- ã‚¿ãƒ–ç®¡ç† ---
    function showTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tabBtn-' + tabId).classList.add('active');
        
        if(tabId === 'remote') {
            document.getElementById('pane-remote-head').classList.add('active');
            document.getElementById('btn-quick-record').style.display = "block";
        } else {
            document.getElementById('pane-' + tabId).classList.add('active');
            document.getElementById('btn-quick-record').style.display = "none";
        }
    }

    // --- ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ“ä½œ ---
    function addCounter(type, val) {
        db.ref('counter/' + type).transaction(c => Math.max(0, (c || 0) + val));
    }
    db.ref('counter/setCount').on('value', s => document.getElementById('display-setCount').innerText = s.val() || 1);
    db.ref('counter/pullCount').on('value', s => document.getElementById('display-pullCount').innerText = s.val() || 0);

    // --- ã‚¿ã‚¤ãƒãƒ¼ & è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ---
    db.ref('counter/currentTime').on('value', (snap) => {
        currentSec = snap.val() || 0;
        const m = Math.floor(currentSec/60); const s = currentSec%60;
        document.getElementById('remoteTimer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        if(document.getElementById('autoScroll').checked) {
            autoScrollToList(currentSec);
        }
    });

    function controlTimer(action) {
        if(action === 'start'){
            if(timerInterval) return;
            timerInterval = setInterval(() => db.ref('counter/currentTime').transaction(t => (t||0)+1), 1000);
        } else {
            clearInterval(timerInterval); timerInterval = null;
            if(action === 'reset') db.ref('counter/currentTime').set(0);
        }
    }

    function autoScrollToList(sec) {
        const items = document.querySelectorAll('.memo-item');
        let target = null;
        items.forEach(el => {
            el.classList.remove('active-now');
            const time = parseInt(el.getAttribute('data-sec'));
            if(time <= sec) target = el;
        });
        if(target) {
            target.classList.add('active-now');
            // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç† ---
    db.ref('contentsList').on('value', (snap) => {
        const list = snap.val() || { "default": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ" };
        const select = document.getElementById('contentSelect');
        const lastVal = select.value;
        select.innerHTML = "";
        Object.entries(list).forEach(([id, name]) => {
            const opt = document.createElement('option'); opt.value = id; opt.innerText = name;
            select.appendChild(opt);
        });
        if(lastVal) select.value = lastVal;
        changeContent();
    });

    function addContentName() {
        const name = prompt("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šæ¥µãƒ€ã‚¤ãƒ¤ã‚¦ã‚§ãƒãƒ³ï¼‰");
        if(name) db.ref(`contentsList/ID_${Date.now()}`).set(name);
    }

    function changeContent() {
        const id = document.getElementById('contentSelect').value;
        db.ref('activeContentID').set(id);
        loadMemos(id);
    }

    // --- ãƒ¡ãƒ¢ä½œæˆãƒ»ç·¨é›† ---
    function setCurrentTimestamp() {
        const m = Math.floor(currentSec/60); const s = currentSec%60;
        const timeStr = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        if(document.getElementById('jumpToEdit').checked) {
            document.getElementById('inTime').value = timeStr;
            showTab('edit');
            document.getElementById('inTitle').focus();
        } else {
            const content = document.getElementById('contentSelect').value;
            db.ref(`savedMemos/${content}`).push({
                timeStr, timeSec: currentSec, title: "ï¼ˆè¨˜éŒ²æ¸ˆï¼šæœªå…¥åŠ›ï¼‰", duration: 3, detail: ""
            });
        }
    }

    function setTmpl(val) {
        document.getElementById('inTitle').value = val;
        document.getElementById('inDuration').value = (val === 'ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚®ãƒŸãƒƒã‚¯ã€‘') ? 20 : 3;
    }

    function saveMemo() {
        const content = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        if(!timeStr || !title) return;

        const data = {
            timeStr,
            timeSec: (parseInt(timeStr.split(':')[0])*60) + parseInt(timeStr.split(':')[1]),
            title,
            duration: 3,
            detail: document.getElementById('inDetail').value
        };

        if(editingKey) {
            db.ref(`savedMemos/${content}/${editingKey}`).update(data);
            cancelEdit();
        } else {
            db.ref(`savedMemos/${content}`).push(data);
        }

        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        document.getElementById('inDetail').value = "";
        showTab('remote');
    }

    function editMemo(key, m) {
        editingKey = key;
        document.getElementById('inTime').value = m.timeStr;
        document.getElementById('inTitle').value = m.title;
        document.getElementById('inDetail').value = m.detail || "";
        document.getElementById('btn-save-main').innerText = "ğŸ’¾ ãƒ¡ãƒ¢ã‚’æ›´æ–°";
        document.getElementById('btn-cancel-edit').style.display = "block";
        showTab('edit');
    }

    function cancelEdit() {
        editingKey = null;
        document.getElementById('btn-save-main').innerText = "ğŸ’¾ ãƒ¡ãƒ¢ã‚’ä¿å­˜";
        document.getElementById('btn-cancel-edit').style.display = "none";
        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        showTab('remote');
    }

    // --- ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º ---
    function loadMemos(id) {
        db.ref(`savedMemos/${id}`).off();
        db.ref(`savedMemos/${id}`).on('value', (snap) => {
            const listDiv = document.getElementById('memoList');
            listDiv.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            
            Object.entries(data).sort((a,b) => a[1].timeSec - b[1].timeSec).forEach(([key, m]) => {
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.setAttribute('data-sec', m.timeSec);
                item.innerHTML = `
                    <div class="memo-info" onclick="db.ref('counter/currentTime').set(${m.timeSec})">
                        <b>[${m.timeStr}]</b> <span>${m.title}</span>
                        <small>${m.detail ? m.detail : 'è©³ç´°ãªã—'}</small>
                    </div>
                    <button class="btn-sm" onclick='editMemo("${key}", ${JSON.stringify(m).replace(/"/g, '&quot;')})'>ç·¨é›†</button>
                    <button class="btn-sm" style="background:#552222;" onclick="if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) db.ref('savedMemos/${id}/${key}').remove()">å‰Šé™¤</button>
                `;
                listDiv.appendChild(item);
            });
        });
    }

    function clearAllMemos() {
        const id = document.getElementById('contentSelect').value;
        if(confirm("ã€è­¦å‘Šã€‘ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ¡ãƒ¢ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) db.ref(`savedMemos/${id}`).remove();
    }
</script>
</body>
</html>
