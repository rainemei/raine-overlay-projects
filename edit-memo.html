<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; padding: 10px; margin: 0; }
        .timer-box { background: #333; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 10px; position: sticky; top: 0; z-index: 100; }
        #timerDisplay { font-size: 32px; font-family: monospace; color: #00ffff; }
        
        .input-card { background: #2a2a2a; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #444; }
        .input-card input, .input-card textarea { width: 100%; padding: 10px; margin-bottom: 5px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; box-sizing: border-box; }
        
        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        .tmpl-group { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .tmpl-btn { background: #444; color: #ddd; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; }

        .memo-item { display: flex; background: #2a2a2a; margin-bottom: 8px; border-radius: 8px; align-items: center; cursor: grab; }
        .handle { padding: 15px; color: #666; font-size: 20px; }
        .memo-info { flex-grow: 1; padding: 10px; }
        .edit-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 200; flex-direction: column; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="timer-box">
        <div id="timerDisplay">00:00</div>
        <button onclick="startTimer()">START</button>
        <button onclick="recordTime()" style="background:#ffc107;">è¨˜éŒ²</button>
        <button onclick="stopTimer()">STOP</button>
        <button onclick="resetTimer()">RESET</button>
    </div>

    <div class="input-card">
        <button onclick="toggleTmpl()" style="font-size:12px; margin-bottom:5px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é–‹ã</button>
            <div id="tmplPopup" style="display:none; flex-wrap:wrap; gap:5px; background:#444; padding:10px; border-radius:5px; margin-bottom:10px;">
                <button class="tmpl-btn" onclick="setTmpl('ã€å…¨ä½“æ”»æ’ƒã€‘')">å…¨ä½“</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€æ•£é–‹ã€‘')">æ•£é–‹</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€å¼·æ”»æ’ƒã€‘')">å¼·æ”»æ’ƒ</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€é ­å‰²ã‚Šã€‘')">é ­å‰²ã‚Š</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€ã‚®ãƒŸãƒƒã‚¯çµŒéã€‘')">ã‚®ãƒŸãƒƒã‚¯</button>
                <button class="tmpl-btn" onclick="setTmpl('ã€ã‚¹ãƒ†ãƒ¼ã‚¸ã‚®ãƒŸãƒƒã‚¯ã€‘')">ã‚¹ãƒ†ãƒ¼ã‚¸</button>
            </div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="inTime" placeholder="00:00" style="width:70px;">
            <input type="text" id="inTitle" placeholder="æ¦‚è¦">
            <input type="number" id="inDuration" value="3" style="width:50px;" title="æŒç¶šæ™‚é–“(ç§’)">
        </div>
        <textarea id="inDetail" placeholder="è©³ç´°"></textarea>
        <button onclick="addMemo()" style="width:100%; padding:10px; background:#28a745; color:white; border:none; border-radius:5px;">è¿½åŠ </button>
    </div>

    <div id="memoList"></div>

    <div id="editOverlay" class="edit-overlay">
        <h3>ğŸ“ ã‚®ãƒŸãƒƒã‚¯ä¿®æ­£</h3>
        <div style="display:flex; gap:5px;">
            <input type="text" id="edTime" placeholder="00:00">
            <input type="text" id="edTitle" placeholder="æ¦‚è¦">
            <input type="number" id="edDuration" style="width:60px;">
        </div>
        <textarea id="edDetail" placeholder="è©³ç´°" rows="10"></textarea>
        <button onclick="saveEdit()" style="padding:15px; background:#28a745; color:white; border:none; border-radius:10px;">ä¿å­˜</button>
        <button onclick="closeEdit()" style="padding:10px; background:#666; color:white; border:none; border-radius:10px; margin-top:10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <a href="index.html" style="display:block; text-align:center; padding:20px; color:#aaa;">â† HUBã«æˆ»ã‚‹</a>

    <script>
        // â˜…Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
            authDomain: "raine-overlay-projects.firebaseapp.com",
            databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "raine-overlay-projects",
            storageBucket: "raine-overlay-projects.firebasestorage.app",
            messagingSenderId: "116002218964",
            appId: "1:116002218964:web:616f3503eaebacb4442c41"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let elapsed = 0, timerInterval, currentEditKey = null;

        function startTimer() {
            let start = Date.now() - elapsed;
            timerInterval = setInterval(() => {
                elapsed = Date.now() - start;
                document.getElementById('timerDisplay').innerText = formatTime(elapsed);
                db.ref('counter/currentTime').set(Math.floor(elapsed / 1000));
            }, 100);
        }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
        function resetTimer() { stopTimer(); elapsed = 0; document.getElementById('timerDisplay').innerText="00:00"; db.ref('counter/currentTime').set(0); }
        function formatTime(ms) {
            const m = Math.floor(ms / 60000);
            const s = Math.floor((ms % 60000) / 1000);
            return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }

        // è¨˜éŒ²ãƒœã‚¿ãƒ³ï¼ˆæ™‚é–“ã ã‘å³åº§ã«ä¿å­˜ï¼‰
        function recordTime() {
            const timeStr = formatTime(elapsed);
            const timeSec = Math.floor(elapsed / 1000);
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ç§’ã§è¨˜éŒ²
            db.ref('counter/savedMemos').push({ timeStr, timeSec, title: "ï¼ˆæœªè¨­å®šï¼‰", detail: "", duration: 3 });
        }

        function setTmpl(txt) { document.getElementById('inTitle').value = txt; }

        function addMemo() {
            const time = document.getElementById('inTime').value || "00:00";
            const parts = time.split(':');
            const timeSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            db.ref('counter/savedMemos').push({
                timeStr: time, timeSec,
                title: document.getElementById('inTitle').value,
                detail: document.getElementById('inDetail').value,
                duration: parseInt(document.getElementById('inDuration').value) || 3 // å…¥åŠ›å€¤ã‚’ä¿å­˜
            });
            document.getElementById('inTitle').value = ""; document.getElementById('inDetail').value = "";
        }

        // ãƒªã‚¹ãƒˆè¡¨ç¤º
        db.ref('counter').on('value', (s) => {
            const data = s.val() || {};
            const listDiv = document.getElementById('memoList');
            if (!listDiv) return; // è¦ç´ ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

            listDiv.innerHTML = "";
            const saved = data.savedMemos || {};
            
            // memoOrderãŒã‚ã‚‹å ´åˆã¯ãã‚Œã«å¾“ã„ã€ãªã‘ã‚Œã°savedMemosã®ã‚­ãƒ¼ã‚’ãã®ã¾ã¾ä½¿ã†
            let order = data.memoOrder || [];
            const savedKeys = Object.keys(saved);

            // orderãŒç©ºã€ã¾ãŸã¯ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¨ä¸æ•´åˆãŒã‚ã‚‹å ´åˆã®ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼å‡¦ç†
            if (order.length === 0 || !order.some(key => savedKeys.includes(key))) {
                // æ™‚é–“é †ï¼ˆtimeSecï¼‰ã«ä¸¦ã¹ãŸã‚‚ã®ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¦ã³é †ã«ã™ã‚‹
                order = savedKeys.sort((a, b) => (saved[a].timeSec || 0) - (saved[b].timeSec || 0));
            }

            order.forEach(key => {
                const m = saved[key];
                if (!m) return; // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

                // å¤ã„å½¢å¼ï¼ˆãŸã ã®æ–‡å­—åˆ—ï¼‰ã ã£ãŸå ´åˆã®æ•‘æ¸ˆ
                const displayTitle = (typeof m === 'object') ? (m.title || "ï¼ˆç„¡é¡Œï¼‰") : m;
                const displayTime = (typeof m === 'object') ? (m.timeStr || "--:--") : "00:00";
                const displayDetail = (typeof m === 'object') ? (m.detail || "") : "";

                const item = document.createElement('div');
                item.className = 'memo-item';
                item.setAttribute('data-id', key);
                item.innerHTML = `
                    <div class="handle">â˜°</div>
                    <div class="memo-info" onclick="applyMemo('${key}')">
                        <span style="color:#ffd700; font-family:monospace;">[${displayTime}]</span> 
                        <strong>${displayTitle}</strong>
                        ${displayDetail ? '<div style="font-size:12px; color:#888;">' + displayDetail.substring(0, 20) + '...</div>' : ''}
                    </div>
                    <div style="display:flex;">
                        <button onclick="openEdit('${key}')" style="background:none; border:none; padding:15px; color:#aaa; font-size:18px;">âœ</button>
                        <button onclick="deleteMemo('${key}')" style="background:none; border:none; padding:15px; color:#dc3545; font-size:18px;">Ã—</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        });

        // ä¸¦ã³æ›¿ãˆæœ‰åŠ¹åŒ–
        Sortable.create(document.getElementById('memoList'), {
            handle: '.handle',
            onEnd: function() {
                const newOrder = Array.from(document.getElementById('memoList').children).map(el => el.getAttribute('data-id'));
                db.ref('counter/memoOrder').set(newOrder);
            }
        });

        function openEdit(key) {
            currentEditKey = key;
            db.ref('counter/savedMemos/'+key).once('value', (s) => {
                const d = s.val();
                document.getElementById('edTime').value = d.timeStr;
                document.getElementById('edTitle').value = d.title;
                document.getElementById('edDetail').value = d.detail;
                document.getElementById('edDuration').value = d.duration || 3; // èª­ã¿è¾¼ã¿
                document.getElementById('editOverlay').style.display = 'flex';
            });
        }

        function saveEdit() {
            const time = document.getElementById('edTime').value;
            const parts = time.split(':');
            const timeSec = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            db.ref('counter/savedMemos/'+currentEditKey).update({
                timeStr: time, timeSec,
                title: document.getElementById('edTitle').value,
                detail: document.getElementById('edDetail').value,
                duration: parseInt(document.getElementById('edDuration').value) || 3 // æ›´æ–°
            });
            closeEdit();
        }

        function closeEdit() { document.getElementById('editOverlay').style.display='none'; }
        function deleteMemo(key) { if(confirm('å‰Šé™¤ï¼Ÿ')) db.ref('counter/savedMemos/'+key).remove(); }

        function toggleTmpl() {
            const p = document.getElementById('tmplPopup');
            p.style.display = (p.style.display === 'none') ? 'flex' : 'none';
        }
        function setTmpl(txt) {
            document.getElementById('inTitle').value = txt;
            toggleTmpl(); // é¸ã‚“ã ã‚‰é–‰ã˜ã‚‹
        }
    </script>
</body>
</html>