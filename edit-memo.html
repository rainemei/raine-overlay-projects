<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Controller Pro v3</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* „É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆÈ™®Ê†º */
        body { font-family: sans-serif; background: #111; color: white; padding: 0; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .fixed-header { flex-shrink: 0; background: #222; z-index: 1000; border-bottom: 1px solid #444; }
        .scroll-content { flex-grow: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }

        /* „Çø„Éñ */
        .tabs { display: flex; border-bottom: 1px solid #444; }
        .tab-btn { flex: 1; background: #222; color: #888; border: none; padding: 15px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { background: #333; color: #00ffff; border-bottom: 3px solid #00ffff; }

        /* „Çø„Ç§„Éû„Éº„Éª„Ç´„Ç¶„É≥„Çø„Éº */
        .timer-display { text-align: center; font-family: monospace; font-size: 48px; color: #00ffff; margin: 5px 0; }
        .counter-bar { display: flex; justify-content: center; gap: 20px; background: #222; padding: 5px 0; font-size: 14px; border-bottom: 1px solid #333; }
        .counter-item { display: flex; align-items: center; gap: 8px; }
        .counter-btn { width: 30px; padding: 2px; background: #444; color: white; border-radius: 4px; font-size: 16px; }

        /* ÂêÑÁ®Æ„Çπ„Ç§„ÉÉ„ÉÅ */
        .switch-area { display: flex; justify-content: space-around; padding: 10px; background: #2a2a2a; font-size: 12px; }
        .toggle-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }

        /* ÂÖ•Âäõ„Éë„Éº„ÉÑ */
        .tab-pane { display: none; padding: 15px; }
        .tab-pane.active { display: block; }
        .input-card { background: #333; padding: 15px; border-radius: 8px; }
        input, select, textarea { width: 100%; margin-bottom: 10px; background: #444; border: 1px solid #555; color: white; padding: 12px; box-sizing: border-box; font-size: 16px; border-radius: 4px; }
        
        button { padding: 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-main { background: #007bff; color: white; width: 100%; }
        .btn-timestamp { background: #17a2b8; color: white; width: 100%; font-size: 18px; margin-top: 10px; }
        .tmpl-btn { background: #555; color: white; margin: 2px; padding: 8px 12px; font-size: 12px; }

        /* „É™„Çπ„Éà */
        .memo-item { background: #2a2a2a; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; border-left: 5px solid #ffd700; transition: background 0.3s; }
        .memo-item.active-now { background: #3a3a10; border-left-color: #00ffff; box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        .memo-info { flex-grow: 1; }
        .memo-info b { color: #00ffff; font-size: 18px; }
    </style>
</head>
<body>

<div class="fixed-header">
    <div class="tabs">
        <button id="tabBtn-remote" class="tab-btn active" onclick="showTab('remote')">REMOTE</button>
        <button id="tabBtn-edit" class="tab-btn" onclick="showTab('edit')">EDIT</button>
        <button id="tabBtn-manage" class="tab-btn" onclick="showTab('manage')">MANAGE</button>
    </div>

    <div class="counter-bar">
        <div class="counter-item">
            SET: <button class="counter-btn" onclick="addCounter('setCount', -1)">-</button>
            <span id="display-setCount">1</span>
            <button class="counter-btn" onclick="addCounter('setCount', 1)">+</button>
        </div>
        <div class="counter-item" style="border-left: 1px solid #444; padding-left: 20px;">
            PULL: <button class="counter-btn" onclick="addCounter('pullCount', -1)">-</button>
            <span id="display-pullCount">0</span>
            <button class="counter-btn" onclick="addCounter('pullCount', 1)">+</button>
        </div>
    </div>

    <div id="pane-remote-head" class="tab-pane active" style="padding: 10px;">
        <div class="timer-display" id="remoteTimer">00:00</div>
        <div style="display: flex; gap: 8px;">
            <button style="flex:1; background:#28a745; color:white;" onclick="controlTimer('start')">START</button>
            <button style="flex:1; background:#ffc107;" onclick="controlTimer('stop')">STOP</button>
            <button style="flex:1; background:#dc3545; color:white;" onclick="controlTimer('reset')">RESET</button>
        </div>
        
        <div class="switch-area">
            <label class="toggle-label"><input type="checkbox" id="autoScroll" checked> AUTO„Çπ„ÇØ„É≠„Éº„É´</label>
            <label class="toggle-label"><input type="checkbox" id="jumpToEdit"> Ë®òÈå≤ÊôÇEDIT„Å∏ÁßªÂãï</label>
        </div>
        
        <button class="btn-timestamp" onclick="setCurrentTimestamp()">üïí ‰ªä„ÅÆÊôÇÈñì„Çí„ÇØ„Ç§„ÉÉ„ÇØË®òÈå≤</button>
    </div>
</div>

<div class="scroll-content" id="listContainer">
    <div id="pane-edit" class="tab-pane">
        <div class="input-card">
            <div style="margin-bottom: 10px;">
                <button class="tmpl-btn" onclick="setTmpl('„ÄêÂÖ®‰ΩìÊîªÊíÉ„Äë')">ÂÖ®‰Ωì</button>
                <button class="tmpl-btn" onclick="setTmpl('„ÄêÂº∑ÊîªÊíÉ„Äë')">Âº∑ÊîªÊíÉ</button>
                <button class="tmpl-btn" onclick="setTmpl('„Äê„Çπ„ÉÜ„Éº„Ç∏„ÇÆ„Éü„ÉÉ„ÇØ„Äë')">„Çπ„ÉÜ„Éº„Ç∏</button>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="inTime" placeholder="00:00" style="width:100px;">
                <input type="text" id="inTitle" placeholder="„Çø„Ç§„Éà„É´" style="flex-grow:1;">
            </div>
            <textarea id="inDetail" placeholder="Ë©≥Á¥∞„É°„É¢" rows="2"></textarea>
            <button id="btn-save-main" class="btn-main" onclick="saveMemo()">‰øùÂ≠ò</button>
        </div>
    </div>

    <div id="pane-manage" class="tab-pane">
        <div class="input-card">
            <select id="contentSelect" onchange="changeContent()"></select>
            <button class="btn-main" style="background:#007bff; margin-bottom:10px;" onclick="addContentName()">Ôºã „Ç≥„É≥„ÉÜ„É≥„ÉÑËøΩÂä†</button>
            <button style="background:#666; width:100%; color:white;" onclick="clearAllMemos()">„Ç™„Éº„É´„ÇØ„É™„Ç¢</button>
        </div>
    </div>

    <div id="memoList"></div>
</div>

<script>
    // ‚òÖFirebaseË®≠ÂÆöÔºà„ÅîËá™Ë∫´„ÅÆ„ÇÇ„ÅÆ„ÇíË≤º„Å£„Å¶„Åè„Å†„Åï„ÅÑÔºâ
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let editingKey = null;
    let timerInterval = null;
    let currentSec = 0;

    // --- „Çø„ÉñÂàá„ÇäÊõø„Åà ---
    function showTab(tabId) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tabBtn-' + tabId).classList.add('active');
        
        if(tabId === 'remote') {
            document.getElementById('pane-remote-head').classList.add('active');
        } else {
            document.getElementById('pane-' + tabId).classList.add('active');
        }
    }

    // --- „Ç´„Ç¶„É≥„Çø„ÉºÊ©üËÉΩ ---
    function addCounter(type, val) {
        db.ref('counter/' + type).transaction(c => Math.max(0, (c || 0) + val));
    }
    db.ref('counter/setCount').on('value', s => document.getElementById('display-setCount').innerText = s.val() || 1);
    db.ref('counter/pullCount').on('value', s => document.getElementById('display-pullCount').innerText = s.val() || 0);

    // --- „Çø„Ç§„Éû„Éº„ÉªËá™Âãï„Çπ„ÇØ„É≠„Éº„É´ ---
    db.ref('counter/currentTime').on('value', (snap) => {
        currentSec = snap.val() || 0;
        const m = Math.floor(currentSec/60); const s = currentSec%60;
        document.getElementById('remoteTimer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        if(document.getElementById('autoScroll').checked) {
            autoScrollToList(currentSec);
        }
    });

    function autoScrollToList(sec) {
        const items = document.querySelectorAll('.memo-item');
        let target = null;
        items.forEach(el => {
            el.classList.remove('active-now');
            const time = parseInt(el.getAttribute('data-sec'));
            if(time <= sec) target = el;
        });
        if(target) {
            target.classList.add('active-now');
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // --- Ë®òÈå≤Ê©üËÉΩ ---
    function setCurrentTimestamp() {
        const m = Math.floor(currentSec/60); const s = currentSec%60;
        const timeStr = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        if(document.getElementById('jumpToEdit').checked) {
            document.getElementById('inTime').value = timeStr;
            showTab('edit');
            document.getElementById('inTitle').focus();
        } else {
            // „ÇØ„Ç§„ÉÉ„ÇØ‰øùÂ≠òÔºà„Çø„Ç§„Éà„É´Êú™Ë®≠ÂÆö„Å®„Åó„Å¶‰øùÂ≠òÔºâ
            const content = document.getElementById('contentSelect').value;
            db.ref(`savedMemos/${content}`).push({
                timeStr, timeSec: currentSec, title: "--- Ë®òÈå≤Ê∏à ---", duration: 3
            });
        }
    }
    // --- „Ç≥„É≥„ÉÜ„É≥„ÉÑÁÆ°ÁêÜ ---
    db.ref('contentsList').on('value', (snap) => {
        const list = snap.val() || { "default": "„Éá„Éï„Ç©„É´„Éà" };
        const select = document.getElementById('contentSelect');
        const lastVal = select.value;
        select.innerHTML = "";
        Object.entries(list).forEach(([id, name]) => {
            const opt = document.createElement('option'); opt.value = id; opt.innerText = name;
            select.appendChild(opt);
        });
        if(lastVal) select.value = lastVal;
        changeContent();
    });

    function addContentName() {
        const name = prompt("Êñ∞„Åó„ÅÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑÂêç");
        if(name) db.ref(`contentsList/ID_${Date.now()}`).set(name);
    }

    function changeContent() {
        const id = document.getElementById('contentSelect').value;
        db.ref('activeContentID').set(id);
        loadMemos(id);
    }

    // --- „Çø„Ç§„Éû„ÉºÊìç‰Ωú ---
    db.ref('counter/currentTime').on('value', (snap) => {
        const t = snap.val() || 0;
        const m = Math.floor(t/60); const s = t%60;
        document.getElementById('remoteTimer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    });

    function controlTimer(action) {
        if(action === 'start'){
            if(timerInterval) return;
            timerInterval = setInterval(() => db.ref('counter/currentTime').transaction(t => (t||0)+1), 1000);
        } else {
            clearInterval(timerInterval); timerInterval = null;
            if(action === 'reset') db.ref('counter/currentTime').set(0);
        }
    }

    function adjustTime(sec) {
        db.ref('counter/currentTime').transaction(t => Math.max(0, (t||0)+sec));
    }

    function jumpToTime(timeStr) {
        const p = timeStr.split(':');
        db.ref('counter/currentTime').set(parseInt(p[0])*60 + parseInt(p[1]));
    }

    // --- „É°„É¢‰ΩúÊàê„ÉªÁ∑®ÈõÜ ---
    function setCurrentTimestamp() {
        db.ref('counter/currentTime').once('value', (snap) => {
            const t = snap.val() || 0;
            const m = Math.floor(t/60); const s = t%60;
            document.getElementById('inTime').value = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            showTab('edit');
            document.getElementById('inTitle').focus();
        });
    }

    function setTmpl(val) {
        document.getElementById('inTitle').value = val;
        document.getElementById('inDuration').value = (val === '„Äê„Çπ„ÉÜ„Éº„Ç∏„ÇÆ„Éü„ÉÉ„ÇØ„Äë') ? 20 : 3;
    }

    function saveMemo() {
        const content = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        if(!timeStr || !title) return;

        const data = {
            timeStr,
            timeSec: (parseInt(timeStr.split(':')[0])*60) + parseInt(timeStr.split(':')[1]),
            title,
            duration: parseInt(document.getElementById('inDuration').value) || 3,
            detail: document.getElementById('inDetail').value
        };

        if(editingKey) {
            db.ref(`savedMemos/${content}/${editingKey}`).update(data);
            cancelEdit();
        } else {
            db.ref(`savedMemos/${content}`).push(data);
        }

        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        document.getElementById('inDetail').value = "";
        showTab('remote');
    }

    function editMemo(key, m) {
        editingKey = key;
        document.getElementById('inTime').value = m.timeStr;
        document.getElementById('inTitle').value = m.title;
        document.getElementById('inDuration').value = m.duration;
        document.getElementById('inDetail').value = m.detail || "";
        document.getElementById('btn-save-main').innerText = "üíæ Êõ¥Êñ∞„Åô„Çã";
        document.getElementById('btn-cancel-edit').style.display = "block";
        showTab('edit');
    }

    function cancelEdit() {
        editingKey = null;
        document.getElementById('btn-save-main').innerText = "„É°„É¢„ÇíËøΩÂä†";
        document.getElementById('btn-cancel-edit').style.display = "none";
        document.getElementById('inTime').value = "";
        document.getElementById('inTitle').value = "";
        showTab('remote');
    }

    // --- „É™„Çπ„ÉàË°®Á§∫ ---
    function loadMemos(id) {
        db.ref(`savedMemos/${id}`).off();
        db.ref(`savedMemos/${id}`).on('value', (snap) => {
            const listDiv = document.getElementById('memoList');
            listDiv.innerHTML = "";
            const data = snap.val();
            if(!data) return;
            Object.entries(data).sort((a,b) => a[1].timeSec - b[1].timeSec).forEach(([key, m]) => {
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `
                    <div class="memo-info" onclick="jumpToTime('${m.timeStr}')">
                        <b>[${m.timeStr}]</b> <span>${m.title}</span>
                        <small>„Çø„ÉÉ„Éó„Åß„Ç∏„É£„É≥„Éó / Ë©≥Á¥∞: ${m.detail || '„Å™„Åó'}</small>
                    </div>
                    <div class="memo-item" data-sec="${m.timeSec}">
                    <div style="display:flex;">
                        <button class="btn-edit" onclick='editMemo("${key}", ${JSON.stringify(m).replace(/"/g, '&quot;')})'>Á∑®</button>
                        <button class="btn-edit" style="background:#444;" onclick="if(confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) db.ref('savedMemos/${id}/${key}').remove()">Ê∂à</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        });
    }

    function clearAllMemos() {
        const id = document.getElementById('contentSelect').value;
        if(confirm("„Åì„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„É°„É¢„ÇíÂÖ®„Å¶Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) db.ref(`savedMemos/${id}`).remove();
    }
</script>
</body>
</html>