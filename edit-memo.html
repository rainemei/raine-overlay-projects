<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Timeline Editor</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #222; color: white; padding: 10px; }
        .input-card { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; margin-bottom: 10px; background: #444; border: 1px solid #555; color: white; padding: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-save { background: #28a745; color: white; margin-bottom: 5px; }
        .btn-clear { background: #dc3545; color: white; font-size: 12px; }
        .tmpl-btn { background: #555; color: white; margin: 2px; width: auto; font-size: 12px; display: inline-block; }
        .memo-item { background: #444; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="input-card">
    <label style="font-size: 12px;">【 コンテンツ選択 】</label>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <select id="contentSelect" onchange="loadContentMemos()" style="margin-bottom:0;"></select>
        <button onclick="addContentName()" style="width:auto; background:#007bff; color:white; white-space:nowrap;">新規追加</button>
    </div>

    <div style="border-top: 1px solid #555; margin-top: 10px; padding-top: 10px;">
        <button onclick="toggleTmpl()" style="font-size:12px; margin-bottom:5px;">テンプレートを開く</button>
        <div id="tmplPopup" style="display:none; flex-wrap:wrap; gap:5px; background:#444; padding:10px; border-radius:4px;">
            <button class="tmpl-btn" onclick="setTmpl('【全体攻撃】')">全体</button>
            <button class="tmpl-btn" onclick="setTmpl('【散開】')">散開</button>
            <button class="tmpl-btn" onclick="setTmpl('【強攻撃】')">強攻撃</button>
            <button class="tmpl-btn" onclick="setTmpl('【ステージギミック】')">ステージ</button>
        </div>
    </div>

    <div style="display:flex; gap:5px; margin-top:10px;">
        <input type="text" id="inTime" placeholder="00:00" style="width:70px;">
        <input type="text" id="inTitle" placeholder="タイトル">
        <input type="number" id="inDuration" value="3" style="width:50px;" title="表示秒数">
    </div>
    <textarea id="inDetail" placeholder="詳細メモ (改行可)" rows="3"></textarea>
    <button class="btn-save" onclick="saveMemo()">メモを追加</button>
    <button class="btn-clear" onclick="clearAllMemos()">このコンテンツをオールクリア</button>
</div>

<div id="memoList"></div>

<script>
    // ★Firebase設定（ご自身のものを貼ってください）
    const firebaseConfig = {
        apiKey: "AIzaSyCG9-jWeEglWYEL1eYymQSI5XZjmv39-kk",
        authDomain: "raine-overlay-projects.firebaseapp.com",
        databaseURL: "https://raine-overlay-projects-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "raine-overlay-projects",
        storageBucket: "raine-overlay-projects.firebasestorage.app",
        messagingSenderId: "116002218964",
        appId: "1:116002218964:web:616f3503eaebacb4442c41"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();


    // 1. Firebaseからコンテンツ一覧を取得してセレクトボックスを更新
    db.ref('contentsList').on('value', (snapshot) => {
        const list = snapshot.val() || { "default": "デフォルト" };
        const select = document.getElementById('contentSelect');
        const currentVal = select.value; // 現在の選択を保持
        
        select.innerHTML = "";
        Object.keys(list).forEach(key => {
            const opt = document.createElement('option');
            opt.value = key;
            opt.innerText = list[key];
            select.appendChild(opt);
        });
        
        if (currentVal) select.value = currentVal;
        loadContentMemos(); // メモ一覧も再読込
    });

    // 2. 新しいコンテンツ名を追加する関数
    function addContentName() {
        const name = prompt("新しいコンテンツ名を入力してください（例：ダイヤウェポン）");
        if (!name) return;
        
        // キーに日本語を使うとトラブルの元になるので、IDはタイムスタンプ等にする
        const id = "ID_" + Date.now();
        db.ref(`contentsList/${id}`).set(name);
    }

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    function setTmpl(val) {
        document.getElementById('inTitle').value = val;
        document.getElementById('inDuration').value = (val === '【ステージギミック】') ? 20 : 3;
        document.getElementById('tmplPopup').style.display = 'none';
    }

    function toggleTmpl() {
        const p = document.getElementById('tmplPopup');
        p.style.display = (p.style.display === 'none') ? 'flex' : 'none';
    }

    function saveMemo() {
        const content = document.getElementById('contentSelect').value;
        const timeStr = document.getElementById('inTime').value;
        const title = document.getElementById('inTitle').value;
        const duration = parseInt(document.getElementById('inDuration').value) || 3;
        const detail = document.getElementById('inDetail').value;

        if(!timeStr || !title) return alert("時間とタイトルは必須です");

        db.ref(`savedMemos/${content}`).push({
            timeStr,
            timeSec: timeToSec(timeStr),
            title,
            duration,
            detail
        });

        document.getElementById('inTitle').value = "";
        document.getElementById('inDetail').value = "";
    }

    function timeToSec(str) {
        const parts = str.split(':');
        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    function loadContentMemos() {
        const content = document.getElementById('contentSelect').value;
        const listDiv = document.getElementById('memoList');
        
        // リスナーを一度オフにしてから再設定（二重登録防止）
        db.ref(`savedMemos/${content}`).off();
        db.ref(`savedMemos/${content}`).on('value', (snapshot) => {
            const data = snapshot.val();
            listDiv.innerHTML = "";
            if(!data) return;

            Object.entries(data).sort((a,b) => a[1].timeSec - b[1].timeSec).forEach(([key, memo]) => {
                const item = document.createElement('div');
                item.className = 'memo-item';
                item.innerHTML = `
                    <span>[${memo.timeStr}] ${memo.title}</span>
                    <button onclick="deleteMemo('${key}')" style="width:auto; padding:2px 10px; background:#666; color:white;">削除</button>
                `;
                listDiv.appendChild(item);
            });
        });
    }

    function deleteMemo(key) {
        const content = document.getElementById('contentSelect').value;
        db.ref(`savedMemos/${content}/${key}`).remove();
    }

    function clearAllMemos() {
        const content = document.getElementById('contentSelect').value;
        if(confirm(`コンテンツ「${content}」のメモをすべて削除しますか？`)) {
            db.ref(`savedMemos/${content}`).remove();
        }
    }

    // 初回読み込み
    loadContentMemos();
</script>
</body>
</html>